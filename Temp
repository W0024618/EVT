-- Set the date you want to analyse (change as needed)
DECLARE @TargetDate DATE = '2025-08-21';

WITH CombinedQuery AS(
  SELECT 
    DATEADD(MINUTE, -1 * t1.[MessageLocaleOffset], t1.[MessageUTC]) AS LocaleMessageTime,
    t1.ObjectName1,
    t1.PartitionName2 AS location,
    t5_card.CardNumber,
    t5_admit.value AS AdmitCode,
    t5_dir.value AS Direction,
    t1.ObjectName2,
    t5_rej.value AS Rejection_Type,
    CASE 
        WHEN t3.Name IN ('Contractor', 'Terminated Contractor') THEN t2.Text12
        ELSE CAST(t2.Int1 AS NVARCHAR)
    END AS EmployeeID,
    t3.Name AS PersonnelType,
    t1.PartitionName2,
    t1.MessageType,
    t1.XmlGUID
  FROM [ACVSUJournal_00011028].[dbo].[ACVSUJournalLog] AS t1
  LEFT JOIN [ACVSCore].[Access].[Personnel] AS t2
    ON t1.ObjectIdentity1 = t2.GUID
  LEFT JOIN [ACVSCore].[Access].[PersonnelType] AS t3
    ON t2.[PersonnelTypeId] = t3.[ObjectID]
  LEFT JOIN [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred] AS t5_admit
    ON t1.XmlGUID = t5_admit.GUID AND t5_admit.Name = 'AdmitCode'
  LEFT JOIN [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred] AS t5_dir
    ON t1.XmlGUID = t5_dir.GUID AND t5_dir.Value IN ('InDirection', 'OutDirection')
  LEFT JOIN [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxml] AS t_xml
    ON t1.XmlGUID = t_xml.GUID
  LEFT JOIN (
    SELECT GUID, [value]
    FROM [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred]
    WHERE [Name] IN ('Card', 'CHUID')
  ) AS SCard
    ON t1.XmlGUID = SCard.GUID
  OUTER APPLY (
    SELECT COALESCE(
      TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID/Card)[1]', 'varchar(50)'),
      TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID)[1]', 'varchar(50)'),
      SCard.[value]
    ) AS CardNumber
  ) AS t5_card
  LEFT JOIN [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred] AS t5_Rej
    ON t1.XmlGUID = t5_Rej.GUID AND t5_Rej.Name = 'RejectCode'
  WHERE t1.MessageType = 'CardAdmitted'
    AND t3.Name IN ('Employee', 'Terminated Personnel')
    AND CONVERT(date, DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC)) = @TargetDate
),

-- Aggregate first/last times and swipe count per employee per day
PerEmployee AS (
  SELECT
    EmployeeID,
    PersonnelType,
    PartitionName2,
    CardNumber,
    Dateonly = CONVERT(date, LocaleMessageTime),
    FirstSwipe = MIN(LocaleMessageTime),
    LastSwipe  = MAX(LocaleMessageTime),
    SwipeCount = COUNT(*) 
  FROM CombinedQuery
  GROUP BY EmployeeID, PersonnelType, PartitionName2, CardNumber, CONVERT(date, LocaleMessageTime)
),

-- Join back to CombinedQuery to fetch first/last door & direction rows
FirstLastDetails AS (
  SELECT
    p.Dateonly,
    p.EmployeeID,
    p.PersonnelType,
    p.PartitionName2,
    p.CardNumber,
    p.FirstSwipe,
    fq.ObjectName2    AS First_Door,
    fq.Direction      AS First_Direction,
    p.LastSwipe,
    lq.ObjectName2    AS Last_Door,
    lq.Direction      AS Last_Direction,
    p.SwipeCount,
    DurationSeconds = DATEDIFF(SECOND, p.FirstSwipe, p.LastSwipe),
    -- duration formatted as hh:mi:ss (works while duration < 24 hours)
    Duration = CONVERT(VARCHAR(8), DATEADD(SECOND, DATEDIFF(SECOND, p.FirstSwipe, p.LastSwipe), 0), 108)
  FROM PerEmployee p
  LEFT JOIN CombinedQuery fq
    ON fq.EmployeeID = p.EmployeeID
    AND CONVERT(date, fq.LocaleMessageTime) = p.Dateonly
    AND fq.LocaleMessageTime = p.FirstSwipe
  LEFT JOIN CombinedQuery lq
    ON lq.EmployeeID = p.EmployeeID
    AND CONVERT(date, lq.LocaleMessageTime) = p.Dateonly
    AND lq.LocaleMessageTime = p.LastSwipe
)

SELECT
  Dateonly,
  EmployeeID,
  PersonnelType,
  PartitionName2,
  CardNumber,
  FirstSwipeTime = FirstSwipe,
  FirstSwipe_TimeOnly = CONVERT(time(0), FirstSwipe),
  First_Door,
  First_Direction,
  LastSwipeTime = LastSwipe,
  LastSwipe_TimeOnly = CONVERT(time(0), LastSwipe),
  Last_Door,
  Last_Direction,
  SwipeCount,
  DurationSeconds,
  Duration  -- hh:mm:ss
FROM FirstLastDetails
ORDER BY Dateonly DESC, EmployeeID;










Read below file Query carefully and Below Query Give me Resultt like this ...

LocaleMessageTime	Dateonly	Swipe_Time	EmployeeID	ObjectName1	PersonnelType	PartitionName2	CardNumber	AdmitCode	Direction	Door
57:36.0	20-08-2025	11:57:36 PM	326933	Moradi, Moei	Employee	LT.Vilnius	615016	Admit	InDirection	EMEA_LTU_VNO_GAMA_1st Floor_Community Space
57:11.0	20-08-2025	11:57:11 PM	326933	Moradi, Moei	Employee	LT.Vilnius	615016	Admit	InDirection	EMEA_LT_VNO_GAMA_1st Flr_Parking
49:56.0	20-08-2025	11:49:56 PM	326933	Moradi, Moei	Employee	LT.Vilnius	615016	Admit	OutDirection	EMEA_LTU_VNO_GAMA_1st Floor_Community Space

in shortly this below query give us Raw swipe records i want to calculate Time Duration for Employee 
using , thier fisr swipe and last swipe for specific day ..

so for Duration Update Query and give me Updated QUery carefully..



WITH CombinedQuery AS(
  SELECT 
     DATEADD(MINUTE, -1 * t1.[MessageLocaleOffset], t1.[MessageUTC]) AS LocaleMessageTime,
    t1.ObjectName1,
 t1.PartitionName2 As location,
 t5_card.CardNumber,
t5_admit.value AS AdmitCode,
t5_dir.value AS Direction,
    t1.ObjectName2,
 t5_rej.value AS Rejection_Type,
 CASE 
        WHEN t3.Name IN ('Contractor', 'Terminated Contractor') THEN t2.Text12
        ELSE CAST(t2.Int1 AS NVARCHAR)
    END AS "EmployeeID",
    t3.Name AS PersonnelType,
	t1.PartitionName2,
    t1.MessageType,t1.XmlGUID
 FROM
    [ACVSUJournal_00011028].[dbo].[ACVSUJournalLog] AS t1
LEFT JOIN
    [ACVSCore].[Access].[Personnel] AS t2
    ON t1.ObjectIdentity1 = t2.GUID
LEFT JOIN
    [ACVSCore].[Access].[PersonnelType] AS t3
    ON t2.[PersonnelTypeId] = t3.[ObjectID]
LEFT JOIN
    [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred] AS t5_admit
    ON t1.XmlGUID = t5_admit.GUID
    AND t5_admit.Name = 'AdmitCode'
LEFT JOIN
    [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred] AS t5_dir
    ON t1.XmlGUID = t5_dir.GUID
    AND t5_dir.Value IN ('InDirection', 'OutDirection')
    LEFT JOIN [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxml] AS t_xml
        ON t1.XmlGUID = t_xml.GUID
    -- Pre-pull shredded  Card  row
    LEFT JOIN (
    SELECT GUID, [value]
    FROM [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred]
    WHERE [Name] IN ('Card', 'CHUID')
    ) AS SCard
    ON t1.XmlGUID = SCard.GUID
    /* NEW: three-stage CardNumber resolution */
    OUTER APPLY (
    SELECT COALESCE(
        -- 1) <LogMessage><CHUID><Card> </Card></CHUID>
        TRY_CAST(t_xml.XmlMessage AS XML)
        .value('(/LogMessage/CHUID/Card)[1]', 'varchar(50)'),
        -- 2) <LogMessage><CHUID> </CHUID> (no nested <Card>)
        TRY_CAST(t_xml.XmlMessage AS XML)
        .value('(/LogMessage/CHUID)[1]', 'varchar(50)'),
        -- 3) shredded fallback
        SCard.[value]
    ) AS CardNumber
    ) AS t5_card
 
LEFT JOIN
    [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred] AS t5_Rej
    ON t1.XmlGUID = t5_Rej.GUID
    AND t5_Rej.Name = 'RejectCode'
 
   
   --include both admits and rejects
   WHERE t1.MessageType = 'CardAdmitted' AND t3.Name IN ('Employee', 'Terminated Personnel')
   
   AND CONVERT(date, DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC)) = '2025-08-21')
 
SELECT 
 LocaleMessageTime,
 Dateonly = Convert(date, LocaleMessageTime), 
 Swipe_Time = CONVERT(time(0), LocaleMessageTime),
 EmployeeID,
 ObjectName1,
 PersonnelType,
 PartitionName2,
 CardNumber,
 AdmitCode,
 Direction,
 ObjectName2 As Door,
 Rejection_Type
 FROM CombinedQuery
 Order BY LocaleMessageTime DESC;
