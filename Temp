
python backend/scripts/generate_90_days.py --end 2025-11-23 --window 90 --outdir ./outputs --all-cities



python backend/scripts/build_90day_training.py --end 2025-11-23 --outdir ./outputs --window 90 --all-cities --start 2025-10-01 --force


python backend/scripts/train_all_models.py --outdir ./outputs --models_dir ./models












Save as backend/scripts/train_all_models.py. This




#!/usr/bin/env python3
"""
Scan output directories for training CSV(s) and run ml_training.main for each.

Usage:
  python train_all_models.py --outdir ./outputs --models_dir ./models --pattern training_person_*.csv

Notes:
 - This imports ml_training as a module and calls its main() function programmatically, so
   ml_training must be importable (backend on PYTHONPATH).
 - If ml_training cannot be imported, this script will attempt to call the CLI via subprocess as fallback.
"""
from pathlib import Path
import sys
import argparse
import logging
import subprocess
import importlib
import glob

logging.basicConfig(level=logging.INFO, format='%(asctime)s %(levelname)s %(message)s')

HERE = Path(__file__).resolve()
PROJECT_ROOT = HERE.parents[1]
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))

def find_training_csvs(outdir: Path, pattern="training_person_*.csv"):
    found = list(outdir.glob(f"**/{pattern}"))
    return sorted(found)

def try_import_ml_training():
    try:
        import ml_training as ml_mod
        return ml_mod
    except Exception:
        return None

def run_ml_training_cli(csv_path: Path, models_dir: Path, features=None):
    cmd = [sys.executable, str(PROJECT_ROOT / "backend" / "ml_training.py"), "--input", str(csv_path), "--models_dir", str(models_dir)]
    if features:
        cmd += ["--features", features]
    logging.info("Running ML training CLI: %s", " ".join(cmd))
    subprocess.check_call(cmd)

def main(outdir="./outputs", models_dir="./models", pattern="training_person_*.csv", features=None):
    out_path = Path(outdir)
    models_path = Path(models_dir)
    models_path.mkdir(parents=True, exist_ok=True)

    csvs = find_training_csvs(out_path, pattern)
    if not csvs:
        logging.warning("No training CSVs found under %s matching %s", out_path, pattern)
        return

    ml_mod = try_import_ml_training()
    for csv in csvs:
        logging.info("Training models for %s", csv)
        per_city_models_dir = models_path / csv.parent.name
        per_city_models_dir.mkdir(parents=True, exist_ok=True)
        try:
            if ml_mod and hasattr(ml_mod, "main"):
                # call programmatically
                ml_mod.main(csv, per_city_models_dir, feature_cols=None)
            else:
                run_ml_training_cli(csv, per_city_models_dir, features)
        except Exception:
            logging.exception("Training failed for %s", csv)

if __name__ == "__main__":
    p = argparse.ArgumentParser()
    p.add_argument("--outdir", default="./outputs")
    p.add_argument("--models_dir", default="./models")
    p.add_argument("--pattern", default="training_person_*.csv")
    p.add_argument("--features", default=None)
    args = p.parse_args()
    main(outdir=args.outdir, models_dir=args.models_dir, pattern=args.pattern, features=args.features)






