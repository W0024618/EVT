Update this Query here strickly ....


SELECT
    t1.[ObjectName1],
    t1.[ObjectName2],
    t2.Text12 AS EmployeeID,
    t2.[PersonnelTypeID],
    t3.[Name] AS PersonnelType,
    t1.PartitionName2,
    DATEADD(MINUTE, -1 * t1.[MessageLocaleOffset], t1.[MessageUTC]) AS LocaleMessageTime,
    t1.MessageType,
    CASE
        WHEN t5_dir.Value = 'InDirection' THEN 'IN'
        WHEN t5_dir.Value = 'OutDirection' THEN 'OUT'
        ELSE 'Unknown'
    END AS Swipe,
    t5_card.Value AS CardNumber
INTO
    #CombinedEmployeeData
FROM
    [ACVSUJournal_00011028].[dbo].[ACVSUJournalLog] AS t1
INNER JOIN
    [ACVSCore].[Access].[Personnel] AS t2
    ON t1.ObjectIdentity1 = t2.GUID
INNER JOIN
    [ACVSCore].[Access].[PersonnelType] AS t3
    ON t2.[PersonnelTypeId] = t3.[ObjectID]
LEFT JOIN
    [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred] AS t5_dir
    ON t1.XmlGUID = t5_dir.GUID
    AND t5_dir.Value IN ('InDirection', 'OutDirection')
LEFT JOIN
    [ACVSUJournal_00011028].[dbo].[ACVSUJournalLogxmlShred] AS t5_card
    ON t1.XmlGUID = t5_card.GUID
    AND t5_card.Value NOT IN ('InDirection', 'OutDirection') 
	AND t5_card.value NOT LIKE '%[^0-9]%' 
	AND t5_card.Value IS NOT NULL
    AND LTRIM(RTRIM(t5_card.Value)) <> ''; --Ensures only numeric values are selected
 
-- Final SELECT
SELECT
    [ObjectName1],
    [ObjectName2],
    PersonnelType,
    EmployeeID,
    PartitionName2,
    MessageType,
    Swipe,
    CardNumber,
    LocaleMessageTime
FROM
    #CombinedEmployeeData
WHERE
    LocaleMessageTime BETWEEN '2025-09-24 08:00:00.000' AND '2025-09-25 08:00:00.000'
    AND ObjectName1 IN ('JANCUKOVIC, VACLAVA,')
    AND Swipe IN ('IN', 'OUT')
ORDER BY
    LocaleMessageTime;

	DROP Table #CombinedEmployeeData;





// backend/services/reportService.js
export async function dailyAccessReportEMEA({ from, to, employees = '' }) {
  const pool = await getPool('emea');
  const req  = pool.request();

  req.input('fromDate', sql.Date, from);
  req.input('toDate',   sql.Date, to);
  const employeesParam = (employees && String(employees).trim()) ? String(employees).trim() : null;
  req.input('employees', sql.NVarChar(sql.MAX), employeesParam);

  const query = `
  DECLARE @empCSV NVARCHAR(MAX) = @employees;

;WITH EmpList AS (
  SELECT LTRIM(RTRIM(value)) AS emp
  FROM STRING_SPLIT(ISNULL(@empCSV,''), ',')
  WHERE LTRIM(RTRIM(value)) <> ''
),

-- Step A: compute the local wall-clock datetime once (LocaleMessageTime)
RawSwipes AS (
  SELECT
    t1.ObjectName1,
    t1.ObjectName2,
    t1.Messagetype,
    t2.Text12       AS EmployeeID,
    t3.Name         AS PersonnelType,
    t1.PartitionName2 AS location,

    -- compute local wall-clock exactly once and give it a name
    DATEADD(MINUTE, -1 * t1.[MessageLocaleOffset], t1.[MessageUTC]) AS LocaleMessageTime,

    CASE
      WHEN t5_dir.Value = 'InDirection'  THEN 'IN'
      WHEN t5_dir.Value = 'OutDirection' THEN 'OUT'
      ELSE 'Unknown'
    END AS Swipe,

    t5_card.Value AS CardNumber,
    CAST(t2.Int1 AS NVARCHAR(50)) AS NumericEmployeeID
  FROM ACVSUJournal_00011028.dbo.ACVSUJournalLog AS t1
  INNER JOIN ACVSCore.Access.Personnel     AS t2
    ON t1.ObjectIdentity1 = t2.GUID
  INNER JOIN ACVSCore.Access.PersonnelType AS t3
    ON t2.PersonnelTypeId = t3.ObjectID
  LEFT JOIN ACVSUJournal_00011028.dbo.ACVSUJournalLogxmlShred AS t5_dir
    ON t1.XmlGUID = t5_dir.GUID
    AND t5_dir.Value IN ('InDirection','OutDirection')
  LEFT JOIN ACVSUJournal_00011028.dbo.ACVSUJournalLogxmlShred AS t5_card
    ON t1.XmlGUID = t5_card.GUID
    AND t5_card.Value NOT IN ('InDirection','OutDirection')
    AND t5_card.Value NOT LIKE '%[^0-9]%'
    AND t5_card.Value IS NOT NULL
    AND LTRIM(RTRIM(t5_card.Value)) <> ''
),

-- Step B: apply the strict 08:00-fromDate -> 08:00-(toDate + 1) window using the computed column
Windowed AS (
  SELECT *
  FROM RawSwipes
  WHERE
    LocaleMessageTime >= DATEADD(HOUR, 8, CAST(@fromDate AS DATETIME))
    AND LocaleMessageTime <  DATEADD(HOUR, 8, DATEADD(DAY, 1, CAST(@toDate AS DATETIME)))
)

-- Step C: apply employee filter (if provided) and project final columns
SELECT
  ObjectName1,
  ObjectName2,
  Messagetype,
  PersonnelType,
  EmployeeID,
  location,
  Swipe,
  CardNumber,
  LocaleMessageTime
FROM Windowed w
WHERE
  (
    @empCSV IS NULL
    OR LTRIM(RTRIM(@empCSV)) = ''
    OR EXISTS (
      SELECT 1 FROM EmpList e
      WHERE e.emp = w.ObjectName1
         OR e.emp = w.EmployeeID
         OR e.emp = w.NumericEmployeeID
    )
  )
ORDER BY LocaleMessageTime;
`;

  const { recordset } = await req.query(query);
  return recordset;
}

