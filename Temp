(venv) PS C:\Users\W0024618\Desktop\incidenceDashboard\backend> uvicorn main:app --reload --port 8000
INFO:     Will watch for changes in these directories: ['C:\\Users\\W0024618\\Desktop\\incidenceDashboard\\backend']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [21820] using StatReload
Process SpawnProcess-1:
Traceback (most recent call last):
  File "C:\Program Files\Python313\Lib\multiprocessing\process.py", line 313, in _bootstrap
    self.run()
    ~~~~~~~~^^
  File "C:\Program Files\Python313\Lib\multiprocessing\process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\W0024618\Desktop\incidenceDashboard\Backend\venv\Lib\site-packages\uvicorn\_subprocess.py", line 80, in subprocess_started
    target(sockets=sockets)
    ~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\W0024618\Desktop\incidenceDashboard\Backend\venv\Lib\site-packages\uvicorn\server.py", line 67, in run
    return asyncio_run(self.serve(sockets=sockets), loop_factory=self.config.get_loop_factory())
  File "C:\Program Files\Python313\Lib\asyncio\runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "C:\Program Files\Python313\Lib\asyncio\runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Program Files\Python313\Lib\asyncio\base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "C:\Users\W0024618\Desktop\incidenceDashboard\Backend\venv\Lib\site-packages\uvicorn\server.py", line 71, in serve
    await self._serve(sockets)
  File "C:\Users\W0024618\Desktop\incidenceDashboard\Backend\venv\Lib\site-packages\uvicorn\server.py", line 78, in _serve
    config.load()
    ~~~~~~~~~~~^^
  File "C:\Users\W0024618\Desktop\incidenceDashboard\Backend\venv\Lib\site-packages\uvicorn\config.py", line 439, in load
    self.loaded_app = import_from_string(self.app)
                      ~~~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "C:\Users\W0024618\Desktop\incidenceDashboard\Backend\venv\Lib\site-packages\uvicorn\importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
  File "C:\Program Files\Python313\Lib\importlib\__init__.py", line 88, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 1026, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "C:\Users\W0024618\Desktop\incidenceDashboard\backend\main.py", line 4, in <module>
    from incident_report import router as incident_router
  File "C:\Users\W0024618\Desktop\incidenceDashboard\backend\incident_report.py", line 110, in <module>   
    @router.post("/create", response_model=IncidentOut)
                                           ^^^^^^^^^^^
NameError: name 'IncidentOut' is not defined. Did you mean: 'IncidentReport'?




now we got this error so fix this error carefully and share me fully updated filrs so i can replace file each other..



# incident_report.py  --- additions / replacements for selected parts

import os
import json
from typing import Optional, List, Dict, Any
from datetime import datetime, date, time
from fastapi import APIRouter, HTTPException, UploadFile, File, Form, Depends, Response
from fastapi.responses import FileResponse
from pydantic import BaseModel, Field, EmailStr, validator
from sqlalchemy import Column, Integer, String, DateTime, Text, func, and_
from sqlalchemy.dialects.sqlite import JSON as SQLITE_JSON
from sqlalchemy.orm import Session

from database import Base, engine, SessionLocal

router = APIRouter(prefix="/incident", tags=["incident"])

# Ensure uploads directory exists
BASE_DIR = os.path.dirname(__file__)
UPLOAD_DIR = os.path.join(BASE_DIR, "uploads")
os.makedirs(UPLOAD_DIR, exist_ok=True)

# (Your existing IncidentReport model assumed unchanged)
class IncidentReport(Base):
    __tablename__ = "incident_reports"

    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    # ... (keep all existing columns as-is)
    type_of_incident = Column(String, nullable=False)
    other_type_text = Column(String, nullable=True)
    date_of_report = Column(String, nullable=False)
    time_of_report = Column(String, nullable=False)
    impacted_name = Column(String, nullable=False)
    impacted_employee_id = Column(String, nullable=False)
    was_reported_verbally = Column(Integer, default=0)
    incident_reported_to = Column(String, nullable=True)
    reported_to_details = Column(String, nullable=True)
    location = Column(String, nullable=False)
    reported_by_name = Column(String, nullable=False)
    reported_by_employee_id = Column(String, nullable=False)
    reported_by_email = Column(String, nullable=False)
    reported_by_contact = Column(String, nullable=False)
    date_of_incident = Column(String, nullable=False)
    time_of_incident = Column(String, nullable=False)
    detailed_description = Column(Text, nullable=False)
    immediate_actions_taken = Column(Text, nullable=False)
    accompanying_person = Column(SQLITE_JSON, nullable=True)
    witnesses = Column(SQLITE_JSON, nullable=True)
    witness_contacts = Column(SQLITE_JSON, nullable=True)
    root_cause_analysis = Column(Text, nullable=True)
    preventive_actions = Column(Text, nullable=True)
    proofs = Column(SQLITE_JSON, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)

Base.metadata.create_all(bind=engine)


# ---------- Improved file saving ----------
MAX_UPLOAD_BYTES = 10 * 1024 * 1024  # 10 MB per file (adjust as corporate policy)
ALLOWED_EXTENSIONS = {".png", ".jpg", ".jpeg", ".pdf", ".gif", ".bmp"}

def secure_filename(filename: str) -> str:
    # simple sanitization keeping alnum and a few chars
    name = "".join(c for c in filename if c.isalnum() or c in (" ", ".", "_", "-")).strip()
    return name or "upload"

def save_uploads(upload_files: Optional[List[UploadFile]]) -> List[str]:
    """Save uploaded files under uploads/YYYY/MM/ and return filenames (relative)."""
    if not upload_files:
        return []
    saved = []
    for f in upload_files:
        raw_name = getattr(f, "filename", "upload")
        name = secure_filename(raw_name)
        ext = os.path.splitext(name)[1].lower()
        if ext and ext not in ALLOWED_EXTENSIONS:
            # ignore or raise depending on policy; here we raise
            raise HTTPException(status_code=400, detail=f"File type not allowed: {ext}")
        # read file into memory up to limit
        data = awaitable_readfile(f)
        if len(data) > MAX_UPLOAD_BYTES:
            raise HTTPException(status_code=400, detail=f"File too large: {name}")
        ts = datetime.utcnow().strftime("%Y%m%d%H%M%S%f")
        # create folder by year/month
        y = datetime.utcnow().strftime("%Y")
        m = datetime.utcnow().strftime("%m")
        folder = os.path.join(UPLOAD_DIR, y, m)
        os.makedirs(folder, exist_ok=True)
        filename = f"{ts}_{name}"
        path = os.path.join(folder, filename)
        with open(path, "wb") as fh:
            fh.write(data)
        # store relative path from UPLOAD_DIR (so download endpoint can find later)
        rel = os.path.join(y, m, filename)
        saved.append(rel)
    return saved

# helper to safely read UploadFile contents (sync environment)
def awaitable_readfile(upload_file: UploadFile) -> bytes:
    """Read UploadFile.file.read() safely (UploadFile.file is a SpooledTemporaryFile)."""
    # NOTE: UploadFile.file.read() is blocking but small files ok for sync handlers.
    # If you switch to async endpoints, use await upload_file.read()
    upload_file.file.seek(0)
    data = upload_file.file.read()
    return data


# -------------------------
# Create endpoint (unchanged mostly)
# -------------------------
@router.post("/create", response_model=IncidentOut)
async def create_incident(
    payload: str = Form(...),            # JSON string of all fields (see IncidentCreate)
    proofs: Optional[List[UploadFile]] = File(None)
):
    try:
        data = json.loads(payload)
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Invalid JSON payload: {e}")

    try:
        incident = IncidentCreate.parse_obj(data)
    except Exception as e:
        raise HTTPException(status_code=422, detail=str(e))

    db = SessionLocal()
    try:
        saved_files = []
        if proofs:
            # proofs may be UploadFile objects:
            saved_files = save_uploads_sync(proofs)  # using sync helper
        inst = IncidentReport(
            type_of_incident = incident.type_of_incident.strip(),
            other_type_text = incident.other_type_text.strip() if incident.other_type_text else None,
            date_of_report = incident.date_of_report.isoformat(),
            time_of_report = incident.time_of_report.strftime("%H:%M:%S"),
            impacted_name = incident.impacted_name.strip(),
            impacted_employee_id = incident.impacted_employee_id.strip(),
            was_reported_verbally = 1 if incident.was_reported_verbally else 0,
            incident_reported_to = json.dumps(incident.incident_reported_to) if incident.incident_reported_to else None,
            reported_to_details = incident.reported_to_details.strip() if incident.reported_to_details else None,
            location = incident.location.strip(),
            reported_by_name = incident.reported_by_name.strip(),
            reported_by_employee_id = incident.reported_by_employee_id.strip(),
            reported_by_email = str(incident.reported_by_email),
            reported_by_contact = incident.reported_by_contact.strip(),
            date_of_incident = incident.date_of_incident.isoformat(),
            time_of_incident = incident.time_of_incident.strftime("%H:%M:%S"),
            detailed_description = incident.detailed_description.strip(),
            immediate_actions_taken = incident.immediate_actions_taken.strip(),
            accompanying_person = [p.dict() for p in incident.accompanying_person] if incident.accompanying_person else None,
            witnesses = incident.witnesses if incident.witnesses else None,
            witness_contacts = incident.witness_contacts if incident.witness_contacts else None,
            root_cause_analysis = incident.root_cause_analysis.strip() if incident.root_cause_analysis else None,
            preventive_actions = incident.preventive_actions.strip() if incident.preventive_actions else None,
            proofs = saved_files if saved_files else None,
            created_at = datetime.utcnow()
        )

        db.add(inst)
        db.commit()
        db.refresh(inst)

        # convert incident_reported_to JSON-string back to list for response
        if inst.incident_reported_to:
            try:
                inst.incident_reported_to = json.loads(inst.incident_reported_to)
            except:
                inst.incident_reported_to = None

        return inst

    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=str(e))
    finally:
        db.close()

# small sync wrapper for save_uploads (since we used blocking file.read)
def save_uploads_sync(upload_files: Optional[List[UploadFile]]) -> List[str]:
    if not upload_files:
        return []
    saved = []
    for f in upload_files:
        raw_name = getattr(f, "filename", "upload")
        name = secure_filename(raw_name)
        ext = os.path.splitext(name)[1].lower()
        if ext and ext not in ALLOWED_EXTENSIONS:
            raise HTTPException(status_code=400, detail=f"File type not allowed: {ext}")
        f.file.seek(0)
        data = f.file.read()
        if len(data) > MAX_UPLOAD_BYTES:
            raise HTTPException(status_code=400, detail=f"File too large: {name}")
        ts = datetime.utcnow().strftime("%Y%m%d%H%M%S%f")
        y = datetime.utcnow().strftime("%Y")
        m = datetime.utcnow().strftime("%m")
        folder = os.path.join(UPLOAD_DIR, y, m)
        os.makedirs(folder, exist_ok=True)
        filename = f"{ts}_{name}"
        path = os.path.join(folder, filename)
        with open(path, "wb") as fh:
            fh.write(data)
        rel = os.path.join(y, m, filename)
        saved.append(rel)
    return saved


# -------------------------
# Attachment download
# -------------------------
@router.get("/{incident_id}/attachment/{filename}")
def download_attachment(incident_id: int, filename: str):
    # filename here should be stored relative path (YYYY/MM/ts_name.ext)
    # Compose path and ensure file exists
    safe_path = os.path.normpath(os.path.join(UPLOAD_DIR, filename))
    # Prevent path traversal
    if not safe_path.startswith(os.path.abspath(UPLOAD_DIR)):
        raise HTTPException(status_code=400, detail="Invalid filename")
    if not os.path.exists(safe_path):
        raise HTTPException(status_code=404, detail="Attachment not found")
    return FileResponse(safe_path, filename=os.path.basename(safe_path))


# -------------------------
# Enhanced list endpoint with filters & pagination
# -------------------------
@router.get("/list", response_model=List[IncidentOut])
def list_incidents(
    limit: int = 200,
    page: int = 1,
    page_size: int = 50,
    type_of_incident: Optional[str] = None,
    location: Optional[str] = None,
    start_date: Optional[str] = None,   # ISO date string: YYYY-MM-DD
    end_date: Optional[str] = None      # ISO date string
):
    db = SessionLocal()
    try:
        q = db.query(IncidentReport)
        # filters (date fields are ISO strings; safe to compare lexicographically)
        if type_of_incident:
            q = q.filter(IncidentReport.type_of_incident == type_of_incident)
        if location:
            q = q.filter(IncidentReport.location.ilike(f"%{location}%"))
        if start_date:
            q = q.filter(IncidentReport.date_of_incident >= start_date)
        if end_date:
            q = q.filter(IncidentReport.date_of_incident <= end_date)

        # pagination
        page = max(page, 1)
        page_size = min(max(page_size, 1), 500)
        offset = (page - 1) * page_size

        rows = q.order_by(IncidentReport.created_at.desc()).offset(offset).limit(page_size).all()

        for r in rows:
            if isinstance(r.incident_reported_to, str):
                try:
                    r.incident_reported_to = json.loads(r.incident_reported_to)
                except:
                    r.incident_reported_to = None
        return rows
    finally:
        db.close()


# -------------------------
# Monthly aggregation endpoint
# -------------------------
@router.get("/stats/monthly")
def monthly_stats(year: Optional[int] = None):
    """
    Returns counts grouped by month and incident type.
    Example response:
    {
      "2025-11": {"Medical": 3, "Theft": 1},
      "2025-12": {"Medical": 2, "Other": 5}
    }
    """
    db = SessionLocal()
    try:
        # sqlite strftime on ISO date-string
        month_label = func.strftime('%Y-%m', IncidentReport.date_of_incident).label('month')
        q = db.query(month_label, IncidentReport.type_of_incident, func.count().label('cnt'))
        if year:
            # restrict to that year
            start = f"{year:04d}-01-01"
            end = f"{year:04d}-12-31"
            q = q.filter(IncidentReport.date_of_incident >= start, IncidentReport.date_of_incident <= end)
        q = q.group_by(month_label, IncidentReport.type_of_incident).order_by(month_label.desc())
        rows = q.all()

        out: Dict[str, Dict[str, int]] = {}
        for month, typ, cnt in rows:
            if month is None:
                month = "unknown"
            out.setdefault(month, {})[typ] = cnt
        return out
    finally:
        db.close()


# -------------------------
# Summary stats endpoint (type-wise & severity estimation)
# -------------------------
@router.get("/stats/summary")
def summary_stats():
    """
    Return overall totals, and totals by type and by month (last 12 months).
    """
    db = SessionLocal()
    try:
        total = db.query(func.count(IncidentReport.id)).scalar()
        by_type = db.query(IncidentReport.type_of_incident, func.count().label('cnt')).group_by(IncidentReport.type_of_incident).all()
        # last 12 months counts
        month_label = func.strftime('%Y-%m', IncidentReport.date_of_incident).label('month')
        last_12 = db.query(month_label, func.count().label('cnt')) \
                    .group_by(month_label) \
                    .order_by(month_label.desc()) \
                    .limit(12) \
                    .all()

        return {
            "total": total or 0,
            "by_type": {typ: cnt for typ, cnt in by_type},
            "last_12_months": {m: cnt for m, cnt in last_12}
        }
    finally:
        db.close()









// C:\Users\W0028758\Desktop\incidenceDashboard\frontend\src\components\IncidentList.jsx
import React, { useState, useEffect, useMemo } from 'react';
import {
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Chip,
  IconButton,
  TextField,
  InputAdornment,
  MenuItem,
  Select,
  FormControl,
  InputLabel,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Typography,
  Box,
  Grid,
  Card,
  CardContent,
  LinearProgress,
  Alert,
  Tooltip,
  Badge,
  Avatar,
  AvatarGroup,
  useMediaQuery,
  useTheme
} from '@mui/material';
import {
  Search,
  FilterList,
  Download,
  Visibility,
  Edit,
  Delete,
  Refresh,
  Add,
  BarChart,
  DateRange,
  Warning,
  CheckCircle,
  Pending,
  Person,
  LocationOn,
  AccessTime,
  Category,
  Sort,
  ExpandMore,
  ExpandLess,
  FileCopy
} from '@mui/icons-material';
import { styled } from '@mui/material/styles';
import { format, parseISO, isValid } from 'date-fns';

// API URL - update based on your environment
const API_URL = 'http://localhost:8000';

// Custom styled components for premium look
const PremiumCard = styled(Card)(({ theme }) => ({
  borderRadius: '16px',
  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.08)',
  border: `1px solid ${theme.palette.divider}`,
  transition: 'all 0.3s ease',
  '&:hover': {
    boxShadow: '0 12px 48px rgba(0, 0, 0, 0.12)',
  },
}));

const StatusChip = styled(Chip)(({ theme, severity }) => {
  const colors = {
    high: theme.palette.error.main,
    medium: theme.palette.warning.main,
    low: theme.palette.success.main,
    closed: theme.palette.grey[500]
  };
  return {
    backgroundColor: `${colors[severity]}15`,
    color: colors[severity],
    fontWeight: 600,
    borderRadius: '8px',
  };
});

// Incident severity mapping based on type
const getIncidentSeverity = (type) => {
  const highRisk = ['Medical', 'Security', 'Fire'];
  const mediumRisk = ['Theft', 'Harassment', 'Accident'];
  const lowRisk = ['Maintenance', 'Other'];
  
  if (highRisk.includes(type)) return 'high';
  if (mediumRisk.includes(type)) return 'medium';
  if (lowRisk.includes(type)) return 'low';
  return 'low';
};

// Incident status mapping (mock - you can extend with real status field)
const getIncidentStatus = (incident) => {
  // Mock status based on creation date and type
  const created = new Date(incident.created_at);
  const hoursAgo = (new Date() - created) / (1000 * 60 * 60);
  
  if (hoursAgo > 48) return 'closed';
  if (hoursAgo > 24) return 'in-progress';
  return 'new';
};

const IncidentList = () => {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('md'));
  const isTablet = useMediaQuery(theme.breakpoints.down('lg'));

  // State
  const [incidents, setIncidents] = useState([]);
  const [filteredIncidents, setFilteredIncidents] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [selectedIncident, setSelectedIncident] = useState(null);
  const [dialogOpen, setDialogOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filters, setFilters] = useState({
    type: 'all',
    severity: 'all',
    status: 'all',
    dateRange: 'all'
  });
  const [sortConfig, setSortConfig] = useState({
    key: 'created_at',
    direction: 'desc'
  });
  const [stats, setStats] = useState({
    total: 0,
    high: 0,
    medium: 0,
    low: 0,
    new: 0,
    inProgress: 0,
    closed: 0
  });

  // Fetch incidents
  const fetchIncidents = async () => {
    setLoading(true);
    try {
      const response = await fetch(`${API_URL}/incident/list?limit=200`);
      if (!response.ok) throw new Error('Failed to fetch incidents');
      const data = await response.json();
      setIncidents(data);
      setFilteredIncidents(data);
      calculateStats(data);
    } catch (err) {
      setError(err.message);
      console.error('Error fetching incidents:', err);
    } finally {
      setLoading(false);
    }
  };

  // Calculate statistics
  const calculateStats = (incidentData) => {
    const stats = {
      total: incidentData.length,
      high: 0,
      medium: 0,
      low: 0,
      new: 0,
      inProgress: 0,
      closed: 0
    };

    incidentData.forEach(incident => {
      const severity = getIncidentSeverity(incident.type_of_incident);
      const status = getIncidentStatus(incident);
      
      stats[severity]++;
      stats[status === 'new' ? 'new' : status === 'in-progress' ? 'inProgress' : 'closed']++;
    });

    setStats(stats);
  };

  // Filter and search incidents
  useEffect(() => {
    let result = incidents;

    // Search
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      result = result.filter(incident =>
        incident.impacted_name.toLowerCase().includes(term) ||
        incident.impacted_employee_id.toLowerCase().includes(term) ||
        incident.type_of_incident.toLowerCase().includes(term) ||
        incident.location.toLowerCase().includes(term) ||
        incident.reported_by_name.toLowerCase().includes(term)
      );
    }

    // Filters
    if (filters.type !== 'all') {
      result = result.filter(incident => incident.type_of_incident === filters.type);
    }

    if (filters.severity !== 'all') {
      result = result.filter(incident => getIncidentSeverity(incident.type_of_incident) === filters.severity);
    }

    if (filters.status !== 'all') {
      result = result.filter(incident => getIncidentStatus(incident) === filters.status);
    }

    // Date range filter (simplified)
    if (filters.dateRange !== 'all') {
      const now = new Date();
      result = result.filter(incident => {
        const incidentDate = new Date(incident.date_of_incident);
        const diffDays = Math.floor((now - incidentDate) / (1000 * 60 * 60 * 24));
        
        switch (filters.dateRange) {
          case 'today': return diffDays === 0;
          case 'week': return diffDays <= 7;
          case 'month': return diffDays <= 30;
          default: return true;
        }
      });
    }

    // Sorting
    result.sort((a, b) => {
      const aValue = a[sortConfig.key];
      const bValue = b[sortConfig.key];
      
      if (sortConfig.key === 'created_at' || sortConfig.key.includes('date') || sortConfig.key.includes('time')) {
        const aDate = new Date(aValue);
        const bDate = new Date(bValue);
        return sortConfig.direction === 'asc' ? aDate - bDate : bDate - aDate;
      }
      
      if (sortConfig.key === 'severity') {
        const severityOrder = { high: 3, medium: 2, low: 1 };
        const aSeverity = getIncidentSeverity(a.type_of_incident);
        const bSeverity = getIncidentSeverity(b.type_of_incident);
        return sortConfig.direction === 'asc' 
          ? severityOrder[aSeverity] - severityOrder[bSeverity]
          : severityOrder[bSeverity] - severityOrder[aSeverity];
      }
      
      return sortConfig.direction === 'asc'
        ? String(aValue).localeCompare(String(bValue))
        : String(bValue).localeCompare(String(aValue));
    });

    setFilteredIncidents(result);
  }, [incidents, searchTerm, filters, sortConfig]);

  // Initial fetch
  useEffect(() => {
    fetchIncidents();
  }, []);

  // Handlers
  const handleViewIncident = (incident) => {
    setSelectedIncident(incident);
    setDialogOpen(true);
  };

  const handleCloseDialog = () => {
    setDialogOpen(false);
    setSelectedIncident(null);
  };

  const handleSort = (key) => {
    setSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc'
    }));
  };

  const handleExportData = () => {
    const csv = [
      ['ID', 'Type', 'Severity', 'Impacted Person', 'Employee ID', 'Location', 'Date', 'Time', 'Reported By', 'Status'],
      ...filteredIncidents.map(incident => [
        incident.id,
        incident.type_of_incident,
        getIncidentSeverity(incident.type_of_incident).toUpperCase(),
        incident.impacted_name,
        incident.impacted_employee_id,
        incident.location,
        incident.date_of_incident,
        incident.time_of_incident,
        incident.reported_by_name,
        getIncidentStatus(incident)
      ])
    ].map(row => row.join(',')).join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `incidents_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  };

  // Render functions
  const renderStatusIcon = (status) => {
    switch (status) {
      case 'new': return <Warning sx={{ color: theme.palette.warning.main }} />;
      case 'in-progress': return <Pending sx={{ color: theme.palette.info.main }} />;
      case 'closed': return <CheckCircle sx={{ color: theme.palette.success.main }} />;
      default: return null;
    }
  };

  const renderTable = () => {
    if (isMobile) {
      return renderMobileCards();
    }

    return (
      <TableContainer component={Paper} sx={{ borderRadius: '12px', overflow: 'hidden' }}>
        <Table>
          <TableHead sx={{ backgroundColor: theme.palette.grey[50] }}>
            <TableRow>
              <TableCell sx={{ fontWeight: 700 }}>ID</TableCell>
              <TableCell sx={{ fontWeight: 700 }}>
                <Box display="flex" alignItems="center" gap={0.5}>
                  Type
                  <IconButton size="small" onClick={() => handleSort('type_of_incident')}>
                    <Sort fontSize="small" />
                  </IconButton>
                </Box>
              </TableCell>
              <TableCell sx={{ fontWeight: 700 }}>Severity</TableCell>
              <TableCell sx={{ fontWeight: 700 }}>
                <Box display="flex" alignItems="center" gap={0.5}>
                  Impacted Person
                  <IconButton size="small" onClick={() => handleSort('impacted_name')}>
                    <Sort fontSize="small" />
                  </IconButton>
                </Box>
              </TableCell>
              <TableCell sx={{ fontWeight: 700 }}>Location</TableCell>
              <TableCell sx={{ fontWeight: 700 }}>
                <Box display="flex" alignItems="center" gap={0.5}>
                  Date & Time
                  <IconButton size="small" onClick={() => handleSort('created_at')}>
                    <Sort fontSize="small" />
                  </IconButton>
                </Box>
              </TableCell>
              <TableCell sx={{ fontWeight: 700 }}>Status</TableCell>
              <TableCell sx={{ fontWeight: 700 }}>Actions</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {filteredIncidents.map((incident) => {
              const severity = getIncidentSeverity(incident.type_of_incident);
              const status = getIncidentStatus(incident);
              
              return (
                <TableRow 
                  key={incident.id}
                  hover
                  sx={{ 
                    '&:hover': { backgroundColor: theme.palette.action.hover },
                    cursor: 'pointer'
                  }}
                  onClick={() => handleViewIncident(incident)}
                >
                  <TableCell>
                    <Typography variant="body2" sx={{ fontWeight: 600, color: theme.palette.text.primary }}>
                      #{incident.id.toString().padStart(4, '0')}
                    </Typography>
                  </TableCell>
                  <TableCell>
                    <Box display="flex" alignItems="center" gap={1}>
                      <Category sx={{ color: theme.palette.primary.main, fontSize: 16 }} />
                      <Typography variant="body2">
                        {incident.type_of_incident}
                        {incident.other_type_text && (
                          <Typography component="span" variant="caption" color="text.secondary" sx={{ ml: 1 }}>
                            ({incident.other_type_text})
                          </Typography>
                        )}
                      </Typography>
                    </Box>
                  </TableCell>
                  <TableCell>
                    <StatusChip
                      size="small"
                      label={severity.toUpperCase()}
                      severity={severity}
                    />
                  </TableCell>
                  <TableCell>
                    <Box>
                      <Typography variant="body2" sx={{ fontWeight: 500 }}>
                        {incident.impacted_name}
                      </Typography>
                      <Typography variant="caption" color="text.secondary">
                        ID: {incident.impacted_employee_id}
                      </Typography>
                    </Box>
                  </TableCell>
                  <TableCell>
                    <Box display="flex" alignItems="center" gap={0.5}>
                      <LocationOn sx={{ fontSize: 16, color: theme.palette.text.secondary }} />
                      <Typography variant="body2">
                        {incident.location}
                      </Typography>
                    </Box>
                  </TableCell>
                  <TableCell>
                    <Box>
                      <Typography variant="body2">
                        {format(parseISO(incident.date_of_incident), 'MMM dd, yyyy')}
                      </Typography>
                      <Typography variant="caption" color="text.secondary">
                        {incident.time_of_incident}
                      </Typography>
                    </Box>
                  </TableCell>
                  <TableCell>
                    <Box display="flex" alignItems="center" gap={1}>
                      {renderStatusIcon(status)}
                      <Typography variant="body2" sx={{ 
                        textTransform: 'capitalize',
                        fontWeight: status === 'new' ? 600 : 400
                      }}>
                        {status}
                      </Typography>
                    </Box>
                  </TableCell>
                  <TableCell onClick={(e) => e.stopPropagation()}>
                    <Box display="flex" gap={1}>
                      <Tooltip title="View Details">
                        <IconButton 
                          size="small" 
                          onClick={() => handleViewIncident(incident)}
                          sx={{ 
                            backgroundColor: theme.palette.primary.main + '10',
                            '&:hover': { backgroundColor: theme.palette.primary.main + '20' }
                          }}
                        >
                          <Visibility fontSize="small" sx={{ color: theme.palette.primary.main }} />
                        </IconButton>
                      </Tooltip>
                      <Tooltip title="Edit">
                        <IconButton 
                          size="small"
                          sx={{ 
                            backgroundColor: theme.palette.info.main + '10',
                            '&:hover': { backgroundColor: theme.palette.info.main + '20' }
                          }}
                        >
                          <Edit fontSize="small" sx={{ color: theme.palette.info.main }} />
                        </IconButton>
                      </Tooltip>
                    </Box>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
      </TableContainer>
    );
  };

  const renderMobileCards = () => {
    return (
      <Box display="flex" flexDirection="column" gap={2}>
        {filteredIncidents.map((incident) => {
          const severity = getIncidentSeverity(incident.type_of_incident);
          const status = getIncidentStatus(incident);
          
          return (
            <PremiumCard key={incident.id} onClick={() => handleViewIncident(incident)}>
              <CardContent>
                <Box display="flex" justifyContent="space-between" alignItems="flex-start" mb={1}>
                  <Box>
                    <Typography variant="h6" sx={{ fontWeight: 600 }}>
                      #{incident.id.toString().padStart(4, '0')}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      {incident.type_of_incident}
                    </Typography>
                  </Box>
                  <StatusChip
                    size="small"
                    label={severity.toUpperCase()}
                    severity={severity}
                  />
                </Box>
                
                <Box mb={1}>
                  <Typography variant="body1" sx={{ fontWeight: 500 }}>
                    {incident.impacted_name}
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    ID: {incident.impacted_employee_id}
                  </Typography>
                </Box>
                
                <Box display="flex" justifyContent="space-between" alignItems="center" mb={1}>
                  <Box display="flex" alignItems="center" gap={0.5}>
                    <LocationOn sx={{ fontSize: 14 }} />
                    <Typography variant="caption">{incident.location}</Typography>
                  </Box>
                  <Box display="flex" alignItems="center" gap={0.5}>
                    <AccessTime sx={{ fontSize: 14 }} />
                    <Typography variant="caption">
                      {format(parseISO(incident.date_of_incident), 'MMM dd')}
                    </Typography>
                  </Box>
                </Box>
                
                <Box display="flex" justifyContent="space-between" alignItems="center">
                  <Box display="flex" alignItems="center" gap={0.5}>
                    {renderStatusIcon(status)}
                    <Typography variant="caption" sx={{ textTransform: 'capitalize' }}>
                      {status}
                    </Typography>
                  </Box>
                  <Button 
                    size="small" 
                    variant="outlined"
                    onClick={(e) => {
                      e.stopPropagation();
                      handleViewIncident(incident);
                    }}
                  >
                    View
                  </Button>
                </Box>
              </CardContent>
            </PremiumCard>
          );
        })}
      </Box>
    );
  };

  if (loading) {
    return (
      <Box p={3}>
        <LinearProgress />
      </Box>
    );
  }

  if (error) {
    return (
      <Box p={3}>
        <Alert severity="error" action={
          <Button color="inherit" size="small" onClick={fetchIncidents}>
            Retry
          </Button>
        }>
          {error}
        </Alert>
      </Box>
    );
  }

  return (
    <Box p={isMobile ? 2 : 3}>
      {/* Header */}
      <Box mb={3}>
        <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
          <Box>
            <Typography variant={isMobile ? "h5" : "h4"} sx={{ fontWeight: 700 }}>
              Incident Dashboard
            </Typography>
            <Typography variant="body1" color="text.secondary">
              Manage and monitor all reported incidents
            </Typography>
          </Box>
          <Box display="flex" gap={1}>
            <Tooltip title="Refresh">
              <IconButton onClick={fetchIncidents}>
                <Refresh />
              </IconButton>
            </Tooltip>
            <Tooltip title="Export Data">
              <IconButton onClick={handleExportData}>
                <Download />
              </IconButton>
            </Tooltip>
            <Button
              variant="contained"
              startIcon={<Add />}
              sx={{
                borderRadius: '8px',
                textTransform: 'none',
                fontWeight: 600
              }}
            >
              New Incident
            </Button>
          </Box>
        </Box>

        {/* Stats Cards */}
        <Grid container spacing={2} mb={3}>
          <Grid item xs={6} sm={4} lg={2}>
            <PremiumCard>
              <CardContent>
                <Typography variant="h4" sx={{ fontWeight: 700, color: theme.palette.primary.main }}>
                  {stats.total}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Total Incidents
                </Typography>
              </CardContent>
            </PremiumCard>
          </Grid>
          <Grid item xs={6} sm={4} lg={2}>
            <PremiumCard>
              <CardContent>
                <Typography variant="h4" sx={{ fontWeight: 700, color: theme.palette.error.main }}>
                  {stats.high}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  High Severity
                </Typography>
              </CardContent>
            </PremiumCard>
          </Grid>
          <Grid item xs={6} sm={4} lg={2}>
            <PremiumCard>
              <CardContent>
                <Typography variant="h4" sx={{ fontWeight: 700, color: theme.palette.warning.main }}>
                  {stats.medium}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Medium Severity
                </Typography>
              </CardContent>
            </PremiumCard>
          </Grid>
          <Grid item xs={6} sm={4} lg={2}>
            <PremiumCard>
              <CardContent>
                <Typography variant="h4" sx={{ fontWeight: 700, color: theme.palette.success.main }}>
                  {stats.new}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  New Incidents
                </Typography>
              </CardContent>
            </PremiumCard>
          </Grid>
          <Grid item xs={6} sm={4} lg={2}>
            <PremiumCard>
              <CardContent>
                <Typography variant="h4" sx={{ fontWeight: 700, color: theme.palette.info.main }}>
                  {stats.inProgress}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  In Progress
                </Typography>
              </CardContent>
            </PremiumCard>
          </Grid>
          <Grid item xs={6} sm={4} lg={2}>
            <PremiumCard>
              <CardContent>
                <Typography variant="h4" sx={{ fontWeight: 700, color: theme.palette.grey[600] }}>
                  {stats.closed}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Closed
                </Typography>
              </CardContent>
            </PremiumCard>
          </Grid>
        </Grid>

        {/* Filters and Search */}
        <PremiumCard sx={{ mb: 3 }}>
          <CardContent>
            <Grid container spacing={2} alignItems="center">
              <Grid item xs={12} md={4}>
                <TextField
                  fullWidth
                  placeholder="Search incidents..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  InputProps={{
                    startAdornment: (
                      <InputAdornment position="start">
                        <Search />
                      </InputAdornment>
                    ),
                    sx: { borderRadius: '8px' }
                  }}
                  size="small"
                />
              </Grid>
              
              <Grid item xs={6} sm={3} md={2}>
                <FormControl fullWidth size="small">
                  <InputLabel>Type</InputLabel>
                  <Select
                    value={filters.type}
                    label="Type"
                    onChange={(e) => setFilters({ ...filters, type: e.target.value })}
                  >
                    <MenuItem value="all">All Types</MenuItem>
                    <MenuItem value="Medical">Medical</MenuItem>
                    <MenuItem value="Theft">Theft</MenuItem>
                    <MenuItem value="Other">Other</MenuItem>
                  </Select>
                </FormControl>
              </Grid>
              
              <Grid item xs={6} sm={3} md={2}>
                <FormControl fullWidth size="small">
                  <InputLabel>Severity</InputLabel>
                  <Select
                    value={filters.severity}
                    label="Severity"
                    onChange={(e) => setFilters({ ...filters, severity: e.target.value })}
                  >
                    <MenuItem value="all">All</MenuItem>
                    <MenuItem value="high">High</MenuItem>
                    <MenuItem value="medium">Medium</MenuItem>
                    <MenuItem value="low">Low</MenuItem>
                  </Select>
                </FormControl>
              </Grid>
              
              <Grid item xs={6} sm={3} md={2}>
                <FormControl fullWidth size="small">
                  <InputLabel>Status</InputLabel>
                  <Select
                    value={filters.status}
                    label="Status"
                    onChange={(e) => setFilters({ ...filters, status: e.target.value })}
                  >
                    <MenuItem value="all">All</MenuItem>
                    <MenuItem value="new">New</MenuItem>
                    <MenuItem value="in-progress">In Progress</MenuItem>
                    <MenuItem value="closed">Closed</MenuItem>
                  </Select>
                </FormControl>
              </Grid>
              
              <Grid item xs={6} sm={3} md={2}>
                <FormControl fullWidth size="small">
                  <InputLabel>Date Range</InputLabel>
                  <Select
                    value={filters.dateRange}
                    label="Date Range"
                    onChange={(e) => setFilters({ ...filters, dateRange: e.target.value })}
                  >
                    <MenuItem value="all">All Time</MenuItem>
                    <MenuItem value="today">Today</MenuItem>
                    <MenuItem value="week">This Week</MenuItem>
                    <MenuItem value="month">This Month</MenuItem>
                  </Select>
                </FormControl>
              </Grid>
            </Grid>
          </CardContent>
        </PremiumCard>

        {/* Results Info */}
        <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
          <Typography variant="body1" color="text.secondary">
            Showing {filteredIncidents.length} of {incidents.length} incidents
          </Typography>
          {filteredIncidents.length !== incidents.length && (
            <Button
              size="small"
              onClick={() => {
                setSearchTerm('');
                setFilters({
                  type: 'all',
                  severity: 'all',
                  status: 'all',
                  dateRange: 'all'
                });
              }}
            >
              Clear Filters
            </Button>
          )}
        </Box>

        {/* Incidents Table/Cards */}
        {filteredIncidents.length === 0 ? (
          <PremiumCard>
            <CardContent>
              <Box textAlign="center" py={4}>
                <Typography variant="h6" color="text.secondary" gutterBottom>
                  No incidents found
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Try adjusting your search or filters
                </Typography>
              </Box>
            </CardContent>
          </PremiumCard>
        ) : (
          renderTable()
        )}
      </Box>

      {/* Incident Detail Dialog */}
      <Dialog 
        open={dialogOpen} 
        onClose={handleCloseDialog}
        maxWidth="md"
        fullWidth
        fullScreen={isMobile}
      >
        {selectedIncident && (
          <>
            <DialogTitle sx={{ 
              borderBottom: `1px solid ${theme.palette.divider}`,
              pb: 2
            }}>
              <Box display="flex" justifyContent="space-between" alignItems="center">
                <Typography variant="h5" sx={{ fontWeight: 600 }}>
                  Incident #{selectedIncident.id.toString().padStart(4, '0')}
                </Typography>
                <StatusChip
                  label={getIncidentSeverity(selectedIncident.type_of_incident).toUpperCase()}
                  severity={getIncidentSeverity(selectedIncident.type_of_incident)}
                />
              </Box>
            </DialogTitle>
            
            <DialogContent dividers>
              <Grid container spacing={3}>
                {/* Basic Information */}
                <Grid item xs={12} md={6}>
                  <Typography variant="subtitle2" color="text.secondary" gutterBottom>
                    BASIC INFORMATION
                  </Typography>
                  <Grid container spacing={2}>
                    <Grid item xs={12}>
                      <Typography variant="body2" sx={{ fontWeight: 500 }}>Type of Incident</Typography>
                      <Typography variant="body1">
                        {selectedIncident.type_of_incident}
                        {selectedIncident.other_type_text && ` (${selectedIncident.other_type_text})`}
                      </Typography>
                    </Grid>
                    <Grid item xs={6}>
                      <Typography variant="body2" sx={{ fontWeight: 500 }}>Date of Incident</Typography>
                      <Typography variant="body1">
                        {format(parseISO(selectedIncident.date_of_incident), 'PPP')}
                      </Typography>
                    </Grid>
                    <Grid item xs={6}>
                      <Typography variant="body2" sx={{ fontWeight: 500 }}>Time of Incident</Typography>
                      <Typography variant="body1">{selectedIncident.time_of_incident}</Typography>
                    </Grid>
                    <Grid item xs={12}>
                      <Typography variant="body2" sx={{ fontWeight: 500 }}>Location</Typography>
                      <Typography variant="body1">{selectedIncident.location}</Typography>
                    </Grid>
                  </Grid>
                </Grid>

                {/* Impacted Person */}
                <Grid item xs={12} md={6}>
                  <Typography variant="subtitle2" color="text.secondary" gutterBottom>
                    IMPACTED PERSON
                  </Typography>
                  <Box p={2} sx={{ backgroundColor: theme.palette.grey[50], borderRadius: 1 }}>
                    <Typography variant="body1" sx={{ fontWeight: 600 }}>
                      {selectedIncident.impacted_name}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      Employee ID: {selectedIncident.impacted_employee_id}
                    </Typography>
                  </Box>
                </Grid>

                {/* Reported By */}
                <Grid item xs={12} md={6}>
                  <Typography variant="subtitle2" color="text.secondary" gutterBottom>
                    REPORTED BY
                  </Typography>
                  <Box p={2} sx={{ backgroundColor: theme.palette.grey[50], borderRadius: 1 }}>
                    <Typography variant="body1" sx={{ fontWeight: 600 }}>
                      {selectedIncident.reported_by_name}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      ID: {selectedIncident.reported_by_employee_id}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      Email: {selectedIncident.reported_by_email}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      Contact: {selectedIncident.reported_by_contact}
                    </Typography>
                  </Box>
                </Grid>

                {/* Incident Details */}
                <Grid item xs={12}>
                  <Typography variant="subtitle2" color="text.secondary" gutterBottom>
                    INCIDENT DETAILS
                  </Typography>
                  <Grid container spacing={2}>
                    <Grid item xs={12}>
                      <Typography variant="body2" sx={{ fontWeight: 500 }}>Detailed Description</Typography>
                      <Typography variant="body1" paragraph>
                        {selectedIncident.detailed_description}
                      </Typography>
                    </Grid>
                    <Grid item xs={12}>
                      <Typography variant="body2" sx={{ fontWeight: 500 }}>Immediate Actions Taken</Typography>
                      <Typography variant="body1" paragraph>
                        {selectedIncident.immediate_actions_taken}
                      </Typography>
                    </Grid>
                  </Grid>
                </Grid>

                {/* Additional Information */}
                <Grid item xs={12} md={6}>
                  <Typography variant="subtitle2" color="text.secondary" gutterBottom>
                    WITNESSES
                  </Typography>
                  {selectedIncident.witnesses && selectedIncident.witnesses.length > 0 ? (
                    <Box display="flex" flexDirection="column" gap={1}>
                      {selectedIncident.witnesses.map((witness, index) => (
                        <Typography key={index} variant="body2">
                          {witness} ({selectedIncident.witness_contacts?.[index] || 'No contact'})
                        </Typography>
                      ))}
                    </Box>
                  ) : (
                    <Typography variant="body2" color="text.secondary">No witnesses reported</Typography>
                  )}
                </Grid>

                <Grid item xs={12} md={6}>
                  <Typography variant="subtitle2" color="text.secondary" gutterBottom>
                    ACCOMPANYING PERSONS
                  </Typography>
                  {selectedIncident.accompanying_person && selectedIncident.accompanying_person.length > 0 ? (
                    <Box display="flex" flexDirection="column" gap={1}>
                      {selectedIncident.accompanying_person.map((person, index) => (
                        <Typography key={index} variant="body2">
                          {person.name} ({person.contact})
                        </Typography>
                      ))}
                    </Box>
                  ) : (
                    <Typography variant="body2" color="text.secondary">No accompanying persons</Typography>
                  )}
                </Grid>

                {/* Analysis */}
                {(selectedIncident.root_cause_analysis || selectedIncident.preventive_actions) && (
                  <Grid item xs={12}>
                    <Typography variant="subtitle2" color="text.secondary" gutterBottom>
                      ANALYSIS & PREVENTION
                    </Typography>
                    <Grid container spacing={2}>
                      {selectedIncident.root_cause_analysis && (
                        <Grid item xs={12} md={6}>
                          <Typography variant="body2" sx={{ fontWeight: 500 }}>Root Cause Analysis</Typography>
                          <Typography variant="body1">
                            {selectedIncident.root_cause_analysis}
                          </Typography>
                        </Grid>
                      )}
                      {selectedIncident.preventive_actions && (
                        <Grid item xs={12} md={6}>
                          <Typography variant="body2" sx={{ fontWeight: 500 }}>Preventive Actions</Typography>
                          <Typography variant="body1">
                            {selectedIncident.preventive_actions}
                          </Typography>
                        </Grid>
                      )}
                    </Grid>
                  </Grid>
                )}
              </Grid>
            </DialogContent>
            
            <DialogActions sx={{ p: 2, borderTop: `1px solid ${theme.palette.divider}` }}>
              <Button onClick={handleCloseDialog}>Close</Button>
              <Button variant="contained" startIcon={<FileCopy />}>
                Create Follow-up
              </Button>
            </DialogActions>
          </>
        )}
      </Dialog>
    </Box>
  );
};

export default IncidentList;


