When i Update this section in trend runner we Got exact filtered data 
but we miss some data like 

Employee has attend office only 3 day and out of 3 day he do Violation 1 time or 2 time this is not display ...
let fix this ..

ex- i Will Explain when Flagg EMployee .
if Employee Visit 1 day and do violation then Flagged 
if Employee visit 2 time and Violation 1 day or 2 day then flagged 
if EMployee visist 3 day and Violation count is 1 or 2, or 3 then Flaggeed 
if Employee Visist 4 day and Violation count day are 2,or 3 or 4 then Flagged 
if Employee Visit 5 day and violation count days are 3 or 4 or 5 then Flagged 
if Employee Visit 6 day and Violation days are 4 or 5 or 6 then Flagged 
If Employee Visit 7 day and Violation days are 5 or 6 or 7 then Flagged 

SO update Condtion carefully and share me Updated Snippet.

    # --- Weekly suppression for short-duration / repeated-break / shortstay-longout / long-gap scenarios ---
    try:
        _weekly_special = {"short_duration_<4h", "coffee_badging","low_swipe_count_<=5","repeated_short_breaks", "shortstay_longout_repeat", "long_gap_>=4.5h"}
        # read up to 7 days (inclusive) of past trend csvs so we can compute week counts for escalation rule
        week_df = _read_past_trend_csvs(str(outdir) if outdir else str(OUTDIR), 7, target_date if target_date else date.today())
        if week_df is not None and not week_df.empty:
            # normalise Date if present
            if 'Date' in week_df.columns:
                try:
                    week_df['Date'] = pd.to_datetime(week_df['Date'], errors='coerce').dt.date
                except Exception:
                    pass

            # build per-person summary maps for this week (present days and scenario-days)
            present_map = defaultdict(int)  # pid -> number of days present in week
            scen_map = {s: defaultdict(int) for s in _weekly_special}  # scenario -> (pid -> days flagged)

            # iterate week history and populate maps
            for _, wr in week_df.iterrows():
                # determine if that historic row counts as present
                present_flag = False
                try:
                    cs = wr.get('CountSwipes')
                    if cs is not None:
                        try:
                            present_flag = int(cs) > 0
                        except Exception:
                            present_flag = str(cs).strip() not in ('0', 'nan', '')
                except Exception:
                    present_flag = False

                # collect normalized identifiers for this historic row
                ids = set()
                for k in ('EmployeeID', 'person_uid', 'EmployeeIdentity', 'CardNumber', 'Int1', 'Text12'):
                    try:
                        v = wr.get(k)
                        if v not in (None, '', float('nan')):
                            nv = _normalize_id_val(v)
                            if nv:
                                ids.add(str(nv))
                                stripped = _strip_uid_prefix(str(nv))
                                if stripped != str(nv):
                                    ids.add(str(stripped))
                    except Exception:
                        continue
                if not ids:
                    continue

                # update maps
                for pid in ids:
                    if present_flag:
                        present_map[pid] += 1
                    for scen in _weekly_special:
                        try:
                            val = wr.get(scen)
                            flag = False
                            if val is not None:
                                if isinstance(val, bool):
                                    flag = val
                                else:
                                    flag = str(val).strip().lower() in ('true', '1', 'yes', 'y', 't')
                            if flag:
                                scen_map[scen][pid] += 1
                        except Exception:
                            continue

            # Now apply suppression to today's df rows:
            for idx, row in df.iterrows():
                # gather normalized ids for current row
                ids_curr = set()
                for k in ('EmployeeID', 'person_uid', 'EmployeeIdentity', 'CardNumber', 'Int1', 'Text12'):
                    try:
                        v = row.get(k)
                        if v not in (None, '', float('nan')):
                            nv = _normalize_id_val(v)
                            if nv:
                                ids_curr.add(str(nv))
                                stripped = _strip_uid_prefix(str(nv))
                                if stripped != str(nv):
                                    ids_curr.add(str(stripped))
                    except Exception:
                        continue
                if not ids_curr:
                    continue

                # aggregate hist counts for this week for all matching ids
                hist_present = 0
                hist_scen_counts = {s: 0 for s in _weekly_special}
                for pid in ids_curr:
                    hist_present += int(present_map.get(pid, 0))
                    for s in _weekly_special:
                        hist_scen_counts[s] += int(scen_map[s].get(pid, 0))

                # include today's presence and today's scenario flag in counts
                present_today = int(row.get('CountSwipes') or 0) > 0
                for s in _weekly_special:
                    current_flag = bool(row.get(s))
                    present_days = hist_present + (1 if present_today else 0)
                    scenario_days = hist_scen_counts[s] + (1 if current_flag else 0)

                    # if employee present < 3 days in week -> no violation (suppress)
                    if present_days < 3:
                        if s in df.columns and bool(df.at[idx, s]):
                            df.at[idx, s] = False
                    else:
                        # present >= 3: only keep scenario if scenario occurs on >= 3 unique days in week
                        if scenario_days < 3:
                            if s in df.columns and bool(df.at[idx, s]):
                                df.at[idx, s] = False
    except Exception:
        logging.exception("Weekly suppression check failed (non-fatal).")

    def compute_score(r):
        score = 0.0
        detected = []
        for name, _ in SCENARIOS:
            val = bool(r.get(name))
            w = WEIGHTS.get(name, 0.0)
            if val and w > 0:
                score += float(w)
                detected.append(name)
        return score, detected

    scores = df.apply(lambda r: pd.Series(compute_score(r), index=['AnomalyScore', 'DetectedScenarios']), axis=1)
    df['AnomalyScore'] = scores['AnomalyScore'].astype(float)
    df['DetectedScenarios'] = scores['DetectedScenarios'].apply(lambda x: "; ".join(x) if (isinstance(x, (list, tuple)) and len(x)>0) else None)
    df['IsFlagged'] = df['AnomalyScore'].apply(lambda s: bool(s >= ANOMALY_THRESHOLD))

