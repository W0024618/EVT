#!/usr/bin/env python3
"""
Create a 90-day training CSV by calling into trend_runner.

Usage:
    python build_90day_training.py --end 2025-11-09 --outdir ./outputs --window 90 --min_unique_employees 1000 --city Pune --force

Behavior:
 - Prefers trend_runner.build_90day_training if available.
 - Falls back to trend_runner.build_monthly_training (approximate months) if not.
 - If --force is provided, it will remove the common 90-day cache file (trend_pune_90day_cache.csv) in outdir before building.
"""
from datetime import date
from pathlib import Path
import sys
import argparse
import os
import math
import shutil
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s %(levelname)s %(message)s')

# Defensive: make backend project root importable
HERE = Path(__file__).resolve()
PROJECT_ROOT = HERE.parents[1]
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))
os.chdir(str(PROJECT_ROOT))

# try to import helpers from trend_runner
try:
    import trend_runner as tr_mod
    # functions we may call
    build_90day_fn = getattr(tr_mod, "build_90day_training", None)
    build_monthly_fn = getattr(tr_mod, "build_monthly_training", None)
    # possible OUTDIR constant inside trend_runner
    TREND_OUTDIR = getattr(tr_mod, "OUTDIR", None)
except Exception:
    tr_mod = None
    build_90day_fn = None
    build_monthly_fn = None
    TREND_OUTDIR = None

def remove_cache_file(outdir: Path):
    # best-effort remove of common cache filename used by the app (fallback names)
    candidates = [
        outdir / "trend_pune_90day_cache.csv",
        outdir / "trend_pune_cache.csv",
        outdir / "trend_90day_cache.csv"
    ]
    removed = []
    for p in candidates:
        try:
            if p.exists():
                p.unlink()
                removed.append(str(p.name))
        except Exception:
            logging.exception("Failed removing cache file %s", p)
    if removed:
        logging.info("Removed cache files: %s", ", ".join(removed))
    else:
        logging.debug("No cache files removed from %s", outdir)

def main(end_date_str=None, outdir="./outputs", window_days=90, min_unique_employees=1000, city="Pune", force=False):
    if end_date_str:
        end_date = date.fromisoformat(end_date_str)
    else:
        end_date = date.today()

    out_path_dir = Path(outdir)
    # if trend_runner provides OUTDIR, prefer that unless user explicitly passed --outdir
    if TREND_OUTDIR and (outdir in (None, "./outputs", "") or str(out_path_dir) == "./outputs"):
        try:
            out_path_dir = Path(TREND_OUTDIR)
        except Exception:
            pass

    out_path_dir.mkdir(parents=True, exist_ok=True)

    if force:
        remove_cache_file(out_path_dir)

    # call the appropriate builder
    if build_90day_fn:
        logging.info("Calling trend_runner.build_90day_training(end_date=%s, window_days=%s, outdir=%s, min_unique_employees=%s, city=%s)",
                     end_date, window_days, out_path_dir, min_unique_employees, city)
        try:
            res = build_90day_fn(end_date=end_date, window_days=window_days, outdir=str(out_path_dir),
                                 min_unique_employees=min_unique_employees, city=city)
            if res:
                print("Training CSV created:", res)
                return res
            else:
                print("Training CSV not created. Check logs and ensure trend CSVs exist in", out_path_dir)
                return None
        except Exception as e:
            logging.exception("build_90day_training raised an exception")
            raise

    # fallback: if a monthly builder exists, call it with approximate months
    if build_monthly_fn:
        approx_months = max(1, int(round(float(window_days) / 30.0)))
        logging.info("trend_runner.build_90day_training not found; falling back to build_monthly_training(months=%s)", approx_months)
        try:
            res = build_monthly_fn(end_date=end_date, months=approx_months, min_unique_employees=min_unique_employees, outdir=str(out_path_dir))
            if res:
                print("Training CSV created (via monthly builder):", res)
                return res
            else:
                print("Training CSV not created (monthly builder). Check logs and ensure trend CSVs exist in", out_path_dir)
                return None
        except Exception:
            logging.exception("build_monthly_training failed")
            raise

    logging.error("No suitable build function found in trend_runner (neither build_90day_training nor build_monthly_training).")
    raise RuntimeError("trend_runner missing required build function")

if __name__ == "__main__":
    p = argparse.ArgumentParser()
    p.add_argument("--end", help="end date (YYYY-MM-DD). default = today", default=None)
    p.add_argument("--outdir", help="outputs dir", default="./outputs")
    p.add_argument("--min_unique_employees", type=int, default=1000)
    p.add_argument("--window", type=int, default=90, help="window days (default 90)")
    p.add_argument("--city", default="Pune")
    p.add_argument("--force", action="store_true", help="force refresh (remove cache files before building)")
    args = p.parse_args()
    main(end_date_str=args.end, outdir=args.outdir, window_days=args.window,
         min_unique_employees=args.min_unique_employees, city=args.city, force=args.force)







