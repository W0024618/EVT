#!/usr/bin/env python3
"""
Generate trend CSVs for a sliding window of days by calling trend_runner.run_trend_for_date.

Usage:
    python generate_90_days.py --end 2025-11-09 --window 90 --city Pune --outdir ./outputs

Notes:
 - Will create outputs directory if missing.
 - Retries a single date once on failure (useful for flaky raw ingestion).
"""
from datetime import date, timedelta
from pathlib import Path
import sys
import os
import argparse
import logging
import time

logging.basicConfig(level=logging.INFO, format='%(asctime)s %(levelname)s %(message)s')

# Make the backend project root importable when running the script directly.
HERE = Path(__file__).resolve()
PROJECT_ROOT = HERE.parents[1]

if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))

# Ensure we run with backend as CWD so relative paths like "./outputs" behave predictably
os.chdir(str(PROJECT_ROOT))

# Now imports should work
try:
    from trend_runner import run_trend_for_date, OUTDIR as TREND_OUTDIR
except Exception:
    # if import fails, let the script still try and fail later with clearer message
    run_trend_for_date = None
    TREND_OUTDIR = None

def process_dates(start_date: date, end_date: date, outdir: Path, city: str, max_retries: int = 1, pause_seconds: float = 1.0):
    d = start_date
    while d <= end_date:
        attempt = 0
        success = False
        while attempt <= max_retries and not success:
            try:
                logging.info("Processing %s (attempt %s)", d.isoformat(), attempt + 1)
                if run_trend_for_date is None:
                    raise RuntimeError("trend_runner.run_trend_for_date not importable. Ensure trend_runner is on PYTHONPATH.")
                # call with both outdir and city if supported
                # many implementations accept (date, outdir=str(...), city=...) â€” passing both is safe for kwargs
                run_trend_for_date(d, outdir=str(outdir), city=city)
                success = True
            except TypeError as te:
                # maybe signature doesn't accept city/outdir as kwargs; try positional fallback
                logging.warning("run_trend_for_date signature mismatch (%s). Trying positional call.", te)
                try:
                    run_trend_for_date(d)
                    success = True
                except Exception as e2:
                    logging.exception("Positional run_trend_for_date call also failed: %s", e2)
            except Exception as e:
                logging.exception("Failed for %s: %s", d.isoformat(), e)
            attempt += 1
            if not success and attempt <= max_retries:
                time.sleep(pause_seconds)
        if not success:
            logging.error("Giving up for %s after %s attempts", d.isoformat(), max_retries + 1)
        d = d + timedelta(days=1)

def main(end_date=None, window_days=90, outdir="./outputs", city="Pune", start_date_override=None):
    if end_date:
        end_dt = date.fromisoformat(end_date)
    else:
        end_dt = date.today()

    if start_date_override:
        start_dt = date.fromisoformat(start_date_override)
    else:
        start_dt = end_dt - timedelta(days=window_days - 1)

    out_path = Path(outdir)
    # prefer TREND_OUTDIR constant from trend_runner if user did not supply explicit outdir
    if TREND_OUTDIR and outdir in ("./outputs", None, ""):
        try:
            out_path = Path(TREND_OUTDIR)
        except Exception:
            pass

    out_path.mkdir(parents=True, exist_ok=True)

    logging.info("Generating trend CSVs for %s -> %s into %s (city=%s)", start_dt.isoformat(), end_dt.isoformat(), out_path, city)
    process_dates(start_dt, end_dt, out_path, city, max_retries=1, pause_seconds=1.0)

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--end", help="end date (YYYY-MM-DD). default = today", default=None)
    parser.add_argument("--start", help="start date (YYYY-MM-DD). optional, overrides window", default=None)
    parser.add_argument("--outdir", help="outputs dir", default="./outputs")
    parser.add_argument("--window", type=int, default=90, help="window days (default 90)")
    parser.add_argument("--city", default="Pune")
    args = parser.parse_args()

    main(end_date=args.end, window_days=args.window, outdir=args.outdir, city=args.city, start_date_override=args.start)







