# --- safe handling for DisplayDate (replace the previous block) ---
if 'DisplayDate' in features.columns:
    try:
        features['_DisplayDate_for_merge'] = pd.to_datetime(features['DisplayDate'], errors='coerce').dt.normalize()
    except Exception:
        features['_DisplayDate_for_merge'] = pd.NaT
    try:
        features['_DisplayDate_for_merge_str'] = pd.to_datetime(features['DisplayDate'], errors='coerce').astype(str).fillna('')
    except Exception:
        # fallback to stringification of the original values
        features['_DisplayDate_for_merge_str'] = features['DisplayDate'].astype(str).fillna('')
else:
    features['_DisplayDate_for_merge'] = pd.NaT
    features['_DisplayDate_for_merge_str'] = ''
# -----------------------------------------------------------------








Still we dont get image and Email so once check below Console details why this happen 


INFO:werkzeug:WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:8002
 * Running on http://10.199.45.239:8002
INFO:werkzeug:Press CTRL+C to quit
INFO:werkzeug: * Restarting with stat
WARNING:werkzeug: * Debugger is active!
INFO:werkzeug: * Debugger PIN: 134-209-644
INFO:root:Fetching swipes for region apac on 2025-11-13
INFO:root:Databases present for server SRVWUPNQ0986V: ['ACVSUJournal_00010030', 'ACVSUJournal_00010029', 'ACVSUJournal_00010028', 'ACVSUJournal_00010027', 'ACVSUJournal_00010026', 'ACVSUJournal_00010025']
INFO:root:Built SQL for region apac, date 2025-11-13
INFO:root:Wrote duration CSV for apac to C:\Users\W0024618\Desktop\Trend Analysis\backend\outputs\apac_duration_20251113.csv (rows=1417)
INFO:root:Wrote swipes CSV for apac to C:\Users\W0024618\Desktop\Trend Analysis\backend\outputs\apac_swipes_20251113.csv (rows=24610)
INFO:root:PersonnelTypeName values example: ['Employee']
INFO:root:PersonnelTypeName filter applied: before=24610 after=24610
INFO:root:PersonnelTypeName values example: ['Employee']
INFO:root:PersonnelTypeName filter applied: before=24610 after=24610
INFO:root:Saved raw swipes to C:\Users\W0024618\Desktop\Trend Analysis\backend\outputs\swipes_pune_20251113.csv
C:\Users\W0024618\Desktop\Trend Analysis\backend\trend_runner.py:4292: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  raw_metrics_df = grouped_raw.apply(_agg_metrics).reset_index()
ERROR:root:Failed recomputing raw metrics (non-fatal)
Traceback (most recent call last):
  File "C:\Users\W0024618\Desktop\Trend Analysis\backend\.venv\Lib\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item 
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item 
KeyError: 'DisplayDate'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\W0024618\Desktop\Trend Analysis\backend\trend_runner.py", line 4297, in run_trend_for_date       
    features['_DisplayDate_for_merge'] = pd.to_datetime(features['DisplayDate'], errors='coerce').dt.normalize()  
                                                        ~~~~~~~~^^^^^^^^^^^^^^^
  File "C:\Users\W0024618\Desktop\Trend Analysis\backend\.venv\Lib\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\W0024618\Desktop\Trend Analysis\backend\.venv\Lib\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'DisplayDate'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\W0024618\Desktop\Trend Analysis\backend\trend_runner.py", line 4306, in run_trend_for_date       
    features['_DisplayDate_for_merge_str'] = pd.to_datetime(features.get('DisplayDate', None), errors='coerce').astype(str).fillna('')
                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'astype'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\W0024618\Desktop\Trend Analysis\backend\trend_runner.py", line 4308, in run_trend_for_date       
    features['_DisplayDate_for_merge_str'] = features.get('DisplayDate', '').astype(str).fillna('')
                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'str' object has no attribute 'astype'
C:\Users\W0024618\Desktop\Trend Analysis\backend\trend_runner.py:3810: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`        
  for ix, r in df[df['CountSwipes'].fillna(0).astype(int) == 0].iterrows():
C:\Users\W0024618\Desktop\Trend Analysis\backend\trend_runner.py:3876: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`        
  df['PresentToday'] = df['CountSwipes'].fillna(0).astype(int) > 0
INFO:root:run_trend_for_date: wrote C:\Users\W0024618\Desktop\Trend Analysis\backend\outputs\trend_pune_20251113.csv (rows=1417)
INFO:werkzeug:127.0.0.1 - - [14/Nov/2025 16:28:52] "GET /run?start=2025-11-13&end=2025-11-13&full=true&region=apac HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [14/Nov/2025 16:29:02] "GET /record?employee_id=302406 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [14/Nov/2025 16:29:14] "GET /record?employee_id=302406 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [14/Nov/2025 16:29:40] "GET /record?employee_id=248816 HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [14/Nov/2025 16:29:56] "GET /record?employee_id=302406 HTTP/1.1" 200 -
