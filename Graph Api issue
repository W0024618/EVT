PS D:\Email Automation\backend-arun> # show last 200 lines of the log
>> Get-Content .\log_file.log -Tail 200
>>
2025-09-01 17:20:25,801 - __main__ - INFO - Displayed 137 records from email_logs table.
PS D:\Email Automation\backend-arun> Resolve-DnsName graph.microsoft.com -Type A
>>

Name                           Type   TTL   Section    NameHost
----                           ----   ---   -------    --------
graph.microsoft.com            CNAME  24    Answer     ags.privatelink.msidentity.com
ags.privatelink.msidentity.com CNAME  24    Answer     www.tm.prd.ags.akadns.net

Name       : www.tm.prd.ags.akadns.net
QueryType  : A
TTL        : 24
Section    : Answer
IP4Address : 20.190.175.88


Name       : www.tm.prd.ags.akadns.net
QueryType  : A
TTL        : 24
Section    : Answer
IP4Address : 20.190.175.152


Name       : www.tm.prd.ags.akadns.net
QueryType  : A
TTL        : 24
Section    : Answer
IP4Address : 20.190.175.24



PS D:\Email Automation\backend-arun> Test-NetConnection graph.microsoft.com -Port 443
>>


ComputerName     : graph.microsoft.com
RemoteAddress    : 20.190.175.88
RemotePort       : 443
InterfaceAlias   : Ethernet0
SourceAddress    : 10.199.22.57
TcpTestSucceeded : True



PS D:\Email Automation\backend-arun> try {
>>   $r = Invoke-WebRequest -Uri "https://graph.microsoft.com/v1.0" -UseBasicParsing -TimeoutSec 10
>>   "Status: " + $r.StatusCode
>> } catch {
>>   "Invoke-WebRequest error: $($_.Exception.Message)"
>> }
Invoke-WebRequest error: The underlying connection was closed: An unexpected error occurred on a send.
PS D:\Email Automation\backend-arun> $clientId = "YOUR_CLIENT_ID"
>> $clientSecret = "YOUR_CLIENT_SECRET"
>> $tenantId = "YOUR_TENANT_ID"
>> $body = @{
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
>>     try { $_.Exception.Response | Select-Object -ExpandProperty StatusCode } catch {}
>>     try { $_.Exception.Response.GetResponseStream() | Select-String -Pattern '.' -Context 0,1 } catch {}
>>   }
>> }
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
>>     try { $_.Exception.Response | Select-Object -ExpandProperty StatusCode } catch {}
>>     try { $_.Exception.Response.GetResponseStream() | Select-String -Pattern '.' -Context 0,1 } catch {}
>>   }
>> $body = @{
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
>>     try { $_.Exception.Response | Select-Object -ExpandProperty StatusCode } catch {}
>>     try { $_.Exception.Response.GetResponseStream() | Select-String -Pattern '.' -Context 0,1 } catch {}
>> $tenantId = "YOUR_TENANT_ID"
>> $body = @{
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
>>     try { $_.Exception.Response | Select-Object -ExpandProperty StatusCode } catch {}
>> $clientSecret = "YOUR_CLIENT_SECRET"
>> $tenantId = "YOUR_TENANT_ID"
>> $body = @{
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
PS D:\Email Automation\backend-arun> $clientId = "YOUR_CLIENT_D"
>> $clientSecret = "YOUR_CLIENT_SECRET"
>> $tenantId = "YOUR_TENANT_ID"
>> $body = @{
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
>>     try { $_.Exception.Response | Select-Object -ExpandProperty StatusCode } catch {}
>>     try { $_.Exception.Response.GetResponseStream() | Select-String -Pattern '.' -Context 0,1 } catch {}
>>   }
>> }
PS D:\Email Automation\backend-arun> $clientId = "YOUR_CLIENTD"
>> $clientSecret = "YOUR_CLIENT_SECRET"
>> $tenantId = "YOUR_TENANT_ID"
>> $body = @{
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
>>     try { $_.Exception.Response | Select-Object -ExpandProperty StatusCode } catch {}
>>     try { $_.Exception.Response.GetResponseStream() | Select-String -Pattern '.' -Context 0,1 } catch {}
>>   }
>> }
PS D:\Email Automation\backend-arun> $clientId = "YOUR_CD"
>> $clientSecret = "YOUR_CLIENT_SECRET"
>> $tenantId = "YOUR_TENANT_ID"
>> $body = @{
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
>>     try { $_.Exception.Response | Select-Object -ExpandProperty StatusCode } catch {}
>>     try { $_.Exception.Response.GetResponseStream() | Select-String -Pattern '.' -Context 0,1 } catch {}
>>   }
>> }
PS D:\Email Automation\backend-arun> $clientId = "6222d611-678e-4d57-a98b-83faa86fce76"
>> $clientSecret = "DKV8Q~Rn4MvlucbxcMsXvAZ6ub_rBVbo-sb6.bGX"
>> $tenantId = "ce3a67f2-5a22-4fb8-a511-815f8924cda6"
>> $body = @{
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
>>     try { $_.Exception.Response | Select-Object -ExpandProperty StatusCode } catch {}
>>     try { $_.Exception.Response.GetResponseStream() | Select-String -Pattern '.' -Context 0,1 } catch {}
>>   }
>> }
>>
Token request failed: The underlying connection was closed: An unexpected error occurred on a send.
PS D:\Email Automation\backend-arun> $clientId = 6222d611-678e-4d57-a98b-83faa86fce76
>> $clientSecret = DKV8Q~Rn4MvlucbxcMsXvAZ6ub_rBVbo-sb6.bGX
>> $tenantId = ce3a67f2-5a22-4fb8-a511-815f8924cda6
>> $body = @{
>>   client_id = $clientId
>>   scope = "https://graph.microsoft.com/.default"
>>   client_secret = $clientSecret
>>   grant_type = "client_credentials"
>> }
>> try {
>>   $resp = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -
Body $body -ContentType "application/x-www-form-urlencoded" -TimeoutSec 20
>>   "Got token. Access token length: $($resp.access_token.Length)"
>> } catch {
>>   "Token request failed: $($_.Exception.Message)"
>>   if ($_.Exception.Response) {
>>     try { $_.Exception.Response | Select-Object -ExpandProperty StatusCode } catch {}
>>     try { $_.Exception.Response.GetResponseStream() | Select-String -Pattern '.' -Context 0,1 } catch {}
>>   }
>> }
>>
6222d611-678e-4d57-a98b-83faa86fce76 : The term '6222d611-678e-4d57-a98b-83faa86fce76' is not recognized as the 
name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or if a path was 
included, verify that the path is correct and try again.
At line:1 char:13
+ $clientId = 6222d611-678e-4d57-a98b-83faa86fce76
+             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (6222d611-678e-4d57-a98b-83faa86fce76:String) [], CommandNotFoundE 
   xception
    + FullyQualifiedErrorId : CommandNotFoundException
 
DKV8Q~Rn4MvlucbxcMsXvAZ6ub_rBVbo-sb6.bGX : The term 'DKV8Q~Rn4MvlucbxcMsXvAZ6ub_rBVbo-sb6.bGX' is not recognized 
as the name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or if a 
path was included, verify that the path is correct and try again.
At line:2 char:17
+ $clientSecret = DKV8Q~Rn4MvlucbxcMsXvAZ6ub_rBVbo-sb6.bGX
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (DKV8Q~Rn4MvlucbxcMsXvAZ6ub_rBVbo-sb6.bGX:String) [], CommandNotFo 
   undException
    + FullyQualifiedErrorId : CommandNotFoundException
 
ce3a67f2-5a22-4fb8-a511-815f8924cda6 : The term 'ce3a67f2-5a22-4fb8-a511-815f8924cda6' is not recognized as the 
name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or if a path was 
included, verify that the path is correct and try again.
At line:3 char:13
+ $tenantId = ce3a67f2-5a22-4fb8-a511-815f8924cda6
+             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (ce3a67f2-5a22-4fb8-a511-815f8924cda6:String) [], CommandNotFoundE 
   xception
    + FullyQualifiedErrorId : CommandNotFoundException
 
Token request failed: The underlying connection was closed: An unexpected error occurred on a send.
PS D:\Email Automation\backend-arun> # list .env if present in current directory
>> if (Test-Path .\.env) { Get-Content .\.env } else { "No .env in current directory" }
>>
#API key for securing endpoints (replace with your existing API key)
API_KEYS=1b9d6bcd-bbfd-4b2d-9b5d-ab8dfbbd4bed
#Microsoft Graph API credentials (placeholders)
CLIENT_ID=6222d611-678e-4d57-a98b-83faa86fce76
CLIENT_SECRET=DKV8Q~Rn4MvlucbxcMsXvAZ6ub_rBVbo-sb6.bGX
TENANT_ID=ce3a67f2-5a22-4fb8-a511-815f8924cda6
# BASE_URL=http://localhost:8000

BASE_URL=http://10.199.22.57:3010
# ENV=testing
TEST_EMAIL=gsoc-globalsecurityoperationcenter.sharedmailbox@westernunion.com
PS D:\Email Automation\backend-arun> # show relevant env vars
>> Get-ChildItem Env:CLIENT_ID,Env:CLIENT_SECRET,Env:TENANT_ID,Env:PRIMARY_EMAIL,Env:TEST_EMAIL,Env:API_KEYS | For
mat-List
>>
Get-ChildItem : Cannot find path 'CLIENT_ID' because it does not exist.
At line:2 char:1
+ Get-ChildItem Env:CLIENT_ID,Env:CLIENT_SECRET,Env:TENANT_ID,Env:PRIMA ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (CLIENT_ID:String) [Get-ChildItem], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetChildItemCommand
 
Get-ChildItem : Cannot find path 'CLIENT_SECRET' because it does not exist.
At line:2 char:1
+ Get-ChildItem Env:CLIENT_ID,Env:CLIENT_SECRET,Env:TENANT_ID,Env:PRIMA ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (CLIENT_SECRET:String) [Get-ChildItem], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetChildItemCommand
 
Get-ChildItem : Cannot find path 'TENANT_ID' because it does not exist.
At line:2 char:1
+ Get-ChildItem Env:CLIENT_ID,Env:CLIENT_SECRET,Env:TENANT_ID,Env:PRIMA ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (TENANT_ID:String) [Get-ChildItem], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetChildItemCommand
 
Get-ChildItem : Cannot find path 'PRIMARY_EMAIL' because it does not exist.
At line:2 char:1
+ Get-ChildItem Env:CLIENT_ID,Env:CLIENT_SECRET,Env:TENANT_ID,Env:PRIMA ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (PRIMARY_EMAIL:String) [Get-ChildItem], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetChildItemCommand
 
Get-ChildItem : Cannot find path 'TEST_EMAIL' because it does not exist.
At line:2 char:1
+ Get-ChildItem Env:CLIENT_ID,Env:CLIENT_SECRET,Env:TENANT_ID,Env:PRIMA ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (TEST_EMAIL:String) [Get-ChildItem], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetChildItemCommand
 
Get-ChildItem : Cannot find path 'API_KEYS' because it does not exist.
At line:2 char:1
+ Get-ChildItem Env:CLIENT_ID,Env:CLIENT_SECRET,Env:TENANT_ID,Env:PRIMA ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (API_KEYS:String) [Get-ChildItem], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetChildItemCommand
 
PS D:\Email Automation\backend-arun> python .\test_graph.py
>>
CLIENT_ID present: False
TENANT_ID present: False
PRIMARY_EMAIL present: False
Traceback (most recent call last):
  File "C:\Users\S326131HQ\AppData\Roaming\Python\Python312\site-packages\msal\authority.py", line 79, in __init__
    openid_config = tenant_discovery(
                    ^^^^^^^^^^^^^^^^^
  File "C:\Users\S326131HQ\AppData\Roaming\Python\Python312\site-packages\msal\authority.py", line 216, in tenant_
discovery
    raise ValueError("OIDC Discovery failed on {}. HTTP status: {}, Error: {}".format(
ValueError: OIDC Discovery failed on https://login.microsoftonline.com/YOUR_TENANT_ID/v2.0/.well-known/openid-conf
iguration. HTTP status: 400, Error: {"error":"invalid_tenant","error_description":"AADSTS90002: Tenant 'your_tenan
t_id' not found. Check to make sure you have the correct tenant ID and are signing into the correct cloud. Check w
ith your subscription administrator, this may happen if there are no active subscriptions for the tenant. Trace ID
: a8427491-867b-4474-bb32-aa2d660f1100 Correlation ID: f81df466-eb31-44b6-af06-e265b3bcb5bd Timestamp: 2025-12-12
05:45:48Z","error_codes":[90002],"timestamp":"2025-12-12 05:45:48Z","trace_id":"a8427491-867b-4474-bb32-aa2d660f11
00","correlation_id":"f81df466-eb31-44b6-af06-e265b3bcb5bd","error_uri":"https://login.microsoftonline.com/error?c
ode=90002"}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\Email Automation\backend-arun\test_graph.py", line 18, in <module>
    app = msal.ConfidentialClientApplication(CLIENT_ID, authority=authority, client_credential=CLIENT_SECRET)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\S326131HQ\AppData\Roaming\Python\Python312\site-packages\msal\application.py", line 645, in __ini
t__
    self.authority = Authority(
                     ^^^^^^^^^^
  File "C:\Users\S326131HQ\AppData\Roaming\Python\Python312\site-packages\msal\authority.py", line 95, in __init__
    raise ValueError(error_message)
ValueError: Unable to get authority configuration for https://login.microsoftonline.com/YOUR_TENANT_ID. Authority
would typically be in a format of https://login.microsoftonline.com/your_tenant or https://tenant_name.ciamlogin.c
om or https://tenant_name.b2clogin.com/tenant.onmicrosoft.com/policy.  Also please double check your tenant name o
r GUID is correct.
PS D:\Email Automation\backend-arun>
