Now Frontend display this error 
Error: Failed to fetch



<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Trend Analysis — Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- React + ReactDOM + Babel (for quick prototyping) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { font-family: Inter, Roboto, Arial, sans-serif; margin: 0; padding: 0; background:#f6f7fb; color:#1f2937; }
      .container { max-width:1200px; margin:24px auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 6px 18px rgba(16,24,40,0.06);}
      header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
      header h1 { margin:0; font-size:20px; }
      .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      input[type="date"] { padding:8px; border-radius:6px; border:1px solid #e2e8f0; }
      button { padding:8px 12px; border-radius:6px; border:0; background:#2563eb; color:#fff; cursor:pointer; }
      button.secondary { background:#64748b; }
      .cards { display:flex; gap:12px; margin-top:16px; }
      .card { flex:1; background:#f8fafc; padding:12px; border-radius:8px; text-align:center; }
      .card h3 { margin:4px 0; font-size:18px; }
      .card p { margin:0; color:#6b7280; }
      .main { display:flex; gap:18px; margin-top:18px; }
      .left { flex: 2; }
      .right { flex: 1; }
      .chart-wrap { background:#fff; padding:10px; border-radius:8px; box-shadow: inset 0 0 0 1px #f1f5f9; }
      table { width:100%; border-collapse:collapse; margin-top:12px; }
      th, td { padding:8px 6px; border-bottom:1px solid #eef2f7; font-size:13px; }
      th { background:#fafafa; position:sticky; top:0; z-index:1; text-align:left; }
      .small { font-size:12px; color:#475569; }
      .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#e6f2ff; color:#075985; font-size:12px; }
      .searchbar { margin-top:12px; display:flex; gap:8px; align-items:center; }
      .searchbar input { padding:8px; border-radius:6px; border:1px solid #e2e8f0; width:240px;}
      .pagination { margin-top:10px; display:flex; gap:8px; align-items:center; }
      .muted { color:#64748b; font-size:13px; }
      pre { white-space:pre-wrap; word-wrap:break-word; background:#0f172a; color:#fff; padding:12px; border-radius:8px; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const {useState, useRef} = React;

      // CONFIG: API host (change if your flask server is elsewhere)
      const API_BASE = "http://10.199.46.101:8002";

      function formatDateISO(d) {
        if (!d) return "";
        const pad = (n) => n.toString().padStart(2,'0');
        return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate());
      }

      function datesBetween(start, end) {
        var out = [];
        var cur = new Date(start);
        while (cur <= end) {
          out.push(new Date(cur));
          cur.setDate(cur.getDate()+1);
        }
        return out;
      }

      function safeDateDisplay(dateStrOrObj) {
        if (!dateStrOrObj && dateStrOrObj !== 0) return "";
        try {
          var d = (dateStrOrObj instanceof Date) ? dateStrOrObj : new Date(dateStrOrObj);
          if (isNaN(d.getTime())) return String(dateStrOrObj);
          return d.toLocaleString();
        } catch (e) {
          return String(dateStrOrObj);
        }
      }

      function App() {
        var yesterday = new Date();
        yesterday.setDate(yesterday.getDate()-1);

        const [dateFrom, setDateFrom] = useState(formatDateISO(yesterday));
        const [dateTo, setDateTo] = useState(formatDateISO(new Date()));
        const [loading, setLoading] = useState(false);
        const [summary, setSummary] = useState({rows:0, flagged_rows:0, files:[], end_date:null});
        const [rows, setRows] = useState([]);
        const [reasonsCount, setReasonsCount] = useState({});
        const [filterText, setFilterText] = useState("");
        const [page, setPage] = useState(1);
        const pageSize = 25;
        const chartRef = useRef(null);
        const chartInst = useRef(null);

        async function runForRange() {
          setLoading(true);
          setRows([]);
          setSummary({rows:0, flagged_rows:0, files:[], end_date:null});
          setReasonsCount({});
          try {
            var start = new Date(dateFrom);
            var end = new Date(dateTo);
            var dates = datesBetween(start, end).map(d => formatDateISO(d));
            var accRows = [];
            var totalRows = 0, totalFlagged = 0, files = [];
            for (var i=0;i<dates.length;i++) {
              var d = dates[i];
              var url = API_BASE + "/run?date=" + d;
              var r = await fetch(url, {method:'GET'});
              if (!r.ok) {
                var text = await r.text();
                throw new Error("API returned " + r.status + ": " + text);
              }
              var js = await r.json();
              var sample = js.sample || [];
              if (Array.isArray(sample) && sample.length) {
                accRows = accRows.concat(sample);
              }
              // handle rows possibly missing
              if (typeof js.rows === 'number') {
                totalRows += js.rows;
              } else {
                totalRows += (Array.isArray(sample) ? sample.length : 0);
              }
              totalFlagged += (js.flagged_rows || 0);
              if (js.files) files = files.concat(js.files);
            }

            setRows(accRows);
            setSummary({rows: totalRows, flagged_rows: totalFlagged, files: files, end_date: formatDateISO(end)});
            computeReasons(accRows);
            setPage(1);
          } catch (err) {
            alert("Error: " + err.message);
            console.error(err);
          } finally {
            setLoading(false);
          }
        }

        async function loadLatest() {
          setLoading(true);
          try {
            var r = await fetch(API_BASE + "/latest");
            if (!r.ok) throw new Error("latest failed: " + r.status);
            var js = await r.json();
            var sample = js.sample || [];
            setRows(sample);
            setSummary({rows: (js.rows || sample.length || 0), flagged_rows: (sample.filter(function(x){return !!x.Reasons}).length || 0), files:[js.file]});
            computeReasons(sample);
            setPage(1);
          } catch (err) {
            alert("Error: " + err.message);
            console.error(err);
          } finally {
            setLoading(false);
          }
        }

        function computeReasons(dataRows) {
          var counts = {};
          (dataRows || []).forEach(function(r){
            if (!r.Reasons) return;
            var parts = String(r.Reasons).split(";").map(function(s){return s.trim()}).filter(Boolean);
            parts.forEach(function(p){ counts[p] = (counts[p] || 0) + 1; });
          });
          setReasonsCount(counts);
          buildChart(counts);
        }

        function buildChart(counts) {
          var labels = Object.keys(counts).sort(function(a,b){return counts[b]-counts[a]});
          var values = labels.map(function(l){return counts[l]});
          var ctx = chartRef.current && chartRef.current.getContext ? chartRef.current.getContext('2d') : null;
          if (!ctx) return;
          try { if (chartInst.current) chartInst.current.destroy(); } catch(e){}
          chartInst.current = new Chart(ctx, {
            type:'bar',
            data:{ labels: labels, datasets:[{ label:'Events', data:values, backgroundColor:'rgba(37,99,235,0.8)' }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
          });
        }

        // table helpers
        var filtered = (rows || []).filter(function(r){
          if (!filterText) return true;
          var s = filterText.toLowerCase();
          var hay = (String(r.EmployeeName||"") + " " + String(r.EmployeeName_x||"") + " " + String(r.EmployeeName_y||"") + " " + String(r.EmployeeID||"") + " " + String(r.CardNumber||"") + " " + String(r.Reasons||"")).toLowerCase();
          return hay.indexOf(s) !== -1;
        });
        var totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
        var pageRows = filtered.slice((page-1)*pageSize, page*pageSize);

        function exportCSV() {
          if (!rows || !rows.length) { alert("No data to export"); return; }
          var cols = Object.keys(rows[0]);
          var lines = [cols.join(",")];
          rows.forEach(function(r){
            var row = cols.map(function(c){
              var v = (r[c] === undefined || r[c] === null) ? "" : String(r[c]).replace(/\n/g,' ');
              return JSON.stringify(v);
            }).join(",");
            lines.push(row);
          });
          var csv = lines.join("\n");
          var blob = new Blob([csv], {type:'text/csv'});
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a'); a.href = url; a.download = 'trend_export.csv'; a.click(); URL.revokeObjectURL(url);
        }

        // Small convenience: compute displayed counts for cards
        var rowsCount = (summary && typeof summary.rows === 'number') ? summary.rows : (rows ? rows.length : 0);
        var flaggedCount = (summary && typeof summary.flagged_rows === 'number') ? summary.flagged_rows : (rows ? rows.filter(function(r){return !!r.Reasons}).length : 0);
        var flaggedPct = rowsCount ? Math.round((flaggedCount*100)/(rowsCount||1)) : 0;

        return (
          <div className="container">
            <header>
              <h1>Trend Analysis — Pune</h1>
              <div className="controls">
                <label className="small">From</label>
                <input type="date" value={dateFrom} onChange={function(e){ setDateFrom(e.target.value); }} />
                <label className="small">To</label>
                <input type="date" value={dateTo} onChange={function(e){ setDateTo(e.target.value); }} />
                <button onClick={runForRange} disabled={loading}>{loading ? 'Running...' : 'Run (date/range)'}</button>
                <button className="secondary" onClick={loadLatest}>Load latest</button>
                <button className="secondary" onClick={exportCSV}>Export CSV</button>
              </div>
            </header>

            <div className="cards">
              <div className="card">
                <h3>{ (rowsCount !== undefined && rowsCount !== null) ? rowsCount : 0 }</h3>
                <p>Rows analysed</p>
              </div>
              <div className="card">
                <h3>{ (flaggedCount !== undefined && flaggedCount !== null) ? flaggedCount : 0 }</h3>
                <p>Flagged rows</p>
              </div>
              <div className="card">
                <h3>{ flaggedPct }%</h3>
                <p>Flagged rate</p>
              </div>
            </div>

            <div className="main">
              <div className="left">
                <div className="chart-wrap" style={{height:240}}>
                  <canvas ref={chartRef}></canvas>
                </div>

                <div className="searchbar">
                  <input placeholder="Search name, employee id, card or reason..." value={filterText} onChange={function(e){ setFilterText(e.target.value); setPage(1); }} />
                  <div className="muted">Showing {filtered.length} / {rows.length} rows</div>
                </div>

                <table>
                  <thead>
                    <tr>
                      <th>Employee</th>
                      <th className="small">ID</th>
                      <th className="small">Card</th>
                      <th className="small">Date</th>
                      <th className="small">Duration</th>
                      <th className="small">Reasons</th>
                      <th className="small">Overlap</th>
                    </tr>
                  </thead>
                  <tbody>
                    {pageRows.map(function(r, idx) {
                      var empName = r.EmployeeName || r.EmployeeName_x || r.EmployeeName_y || r.person_uid || "";
                      var displayDate = safeDateDisplay(r.Date);
                      var durText = r.Duration || (r.DurationMinutes ? Math.round(r.DurationMinutes) + " min" : "");
                      var overlap = r.OverlapWith || r.swipe_overlap || "";
                      return (
                        <tr key={idx}>
                          <td>{ empName || <span className="muted">—</span> }</td>
                          <td className="small">{ r.EmployeeID || "" }</td>
                          <td className="small">{ r.CardNumber || "" }</td>
                          <td className="small">{ displayDate }</td>
                          <td className="small">{ durText }</td>
                          <td className="small">{ r.Reasons ? <span className="pill">{r.Reasons}</span> : <span className="muted">OK</span> }</td>
                          <td className="small">{ overlap ? <span title={String(overlap)}>{String(overlap).split(";").slice(0,3).join(", ")}</span> : <span className="muted">—</span> }</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>

                <div className="pagination">
                  <button onClick={function(){ setPage(function(p){ return Math.max(1,p-1); }); }} disabled={page<=1}>Prev</button>
                  <div className="muted">Page {page} / {totalPages}</div>
                  <button onClick={function(){ setPage(function(p){ return Math.min(totalPages,p+1); }); }} disabled={page>=totalPages}>Next</button>
                </div>
              </div>

              <aside className="right">
                <div style={{marginBottom:12}}>
                  <strong>Files:</strong>
                  <div className="muted">{ (summary.files || []).join(", ") }</div>
                </div>

                <div style={{marginBottom:12}}>
                  <strong>Top reasons</strong>
                  <ul>
                    { Object.entries(reasonsCount).sort(function(a,b){ return b[1]-a[1]; }).slice(0,10).map(function(kv){
                      return <li key={kv[0]}><b>{kv[1]}</b> — <span className="small">{kv[0]}</span></li>;
                    })}
                    { Object.keys(reasonsCount).length === 0 && <div className="muted">No flags found</div> }
                  </ul>
                </div>

                <div>
                  <strong>Help</strong>
                  <div className="small muted" style={{marginTop:6}}>
                    - Click <b>Run</b> to trigger analysis for the chosen date(s).<br/>
                    - Range calls `/run?date=YYYY-MM-DD` for each date in the range sequentially.<br/>
                    - Overlap details live in <code>OverlapWith</code> field (semicolon-separated person_uids).<br/>
                    - If CORS errors occur, enable CORS in Flask or host this file on same host as API.
                  </div>
                </div>

                <div style={{marginTop:12}}>
                  <strong>Raw JSON preview (first row)</strong>
                  <pre>{ rows[0] ? JSON.stringify(rows[0], null, 2) : "No sample yet" }</pre>
                </div>
              </aside>
            </div>
          </div>
        );
      }

      ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
  </body>
</html>
