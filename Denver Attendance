USE [ACVSUJournal_00010021];
GO

SET NOCOUNT ON;

-- Door + Clearance aggregated details
SELECT
  D.ObjectID                 AS DoorObjectID,
  D.Name                     AS DoorName,
  D.GUID                     AS DoorGUID,
  D.ControllerID             AS ControllerID,

  clr.ClearanceCount         AS [Clearance Count],
  clr.ClearanceNames         AS [Clearance Details],       -- concatenated Clearance.Name
  clr.ClearanceDescriptions  AS [Clearance Descriptions],  -- concatenated Clearance.Description
  clr.LatestClearanceTime    AS [Last Modified Time],
  op.Name                    AS [Last Modified By]

FROM ACVSCore.Access.Door D

OUTER APPLY (
    -- Aggregate clearances for this door (assumes Clearance.ObjectID = Door.ObjectID)
    SELECT
      COUNT(1) AS ClearanceCount,

      -- concatenated clearance names (comma separated)
      STUFF((
        SELECT ', ' + ISNULL(C2.Name,'')
        FROM ACVSCore.Access.Clearance C2
        WHERE C2.ObjectID = D.ObjectID
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceNames,

      -- concatenated clearance descriptions (semicolon separated to avoid comma collisions)
      STUFF((
        SELECT '; ' + ISNULL(C2.Description,'')
        FROM ACVSCore.Access.Clearance C2
        WHERE C2.ObjectID = D.ObjectID
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceDescriptions,

      -- latest LastModifiedTime for clearances on this door
      (SELECT TOP(1) C3.LastModifiedTime
       FROM ACVSCore.Access.Clearance C3
       WHERE C3.ObjectID = D.ObjectID
       ORDER BY C3.LastModifiedTime DESC
      ) AS LatestClearanceTime,

      -- LastModifiedByID from the most recent clearance row
      (SELECT TOP(1) C4.LastModifiedByID
       FROM ACVSCore.Access.Clearance C4
       WHERE C4.ObjectID = D.ObjectID
       ORDER BY C4.LastModifiedTime DESC
      ) AS LastModifiedByID
) clr

LEFT JOIN ACVSCore.Access.Personnel op
  ON op.ObjectID = clr.LastModifiedByID

ORDER BY D.Name;
GO













Msg 4104, Level 16, State 1, Line 42
The multi-part identifier "C.LastModifiedTime" could not be bound.
Msg 8155, Level 16, State 2, Line 58
No column name was specified for column 4 of 'clr'.

Completion time: 2025-10-13T11:33:49.6735557+05:30


We got above error message now need to fix carefully ...

USE [ACVSUJournal_00010021];
GO

SET NOCOUNT ON;

-- Door + Clearance details
SELECT
  D.ObjectID                AS DoorObjectID,
  D.Name                    AS DoorName,
  D.GUID                    AS DoorGUID,
  D.ControllerID            AS ControllerID,

  clr.ClearanceCount        AS [Clearance Count],
  clr.ClearanceNames        AS [Clearance Details],        -- concatenated Clearance.Name (e.g. restricted / not)
  clr.ClearanceDescriptions AS [Clearance Descriptions],  -- concatenated Clearance.Description
  clr.LatestClearanceTime   AS [Last Modified Time],
  op.Name                   AS [Last Modified By]         -- operator/personnel name who last modified clearance

FROM ACVSCore.Access.Door D

OUTER APPLY (
    -- aggregate clearances belonging to this door (assumes Clearance.ObjectID = Door.ObjectID)
    SELECT
      COUNT(1) AS ClearanceCount,
      -- concatenated clearance names
      STUFF((
        SELECT ', ' + ISNULL(C2.Name, '')
        FROM ACVSCore.Access.Clearance C2
        WHERE C2.ObjectID = D.ObjectID
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceNames,

      -- concatenated clearance descriptions (semicolon separated to avoid comma collisions)
      STUFF((
        SELECT '; ' + ISNULL(C2.Description, '')
        FROM ACVSCore.Access.Clearance C2
        WHERE C2.ObjectID = D.ObjectID
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceDescriptions,

      -- latest LastModifiedTime for clearances on this door (null if no clearances)
      MAX(C.LastModifiedTime) OVER () /* placeholder, replaced below by scalar from inner SELECT */ ,
      -- pick the most recent LastModifiedTime and the corresponding LastModifiedByID using a TOP subquery
      (SELECT TOP(1) C3.LastModifiedTime
       FROM ACVSCore.Access.Clearance C3
       WHERE C3.ObjectID = D.ObjectID
       ORDER BY C3.LastModifiedTime DESC
      ) AS LatestClearanceTime,

      (SELECT TOP(1) C4.LastModifiedByID
       FROM ACVSCore.Access.Clearance C4
       WHERE C4.ObjectID = D.ObjectID
       ORDER BY C4.LastModifiedTime DESC
      ) AS LastModifiedByID

) clr

LEFT JOIN ACVSCore.Access.Personnel op
  ON op.ObjectID = clr.LastModifiedByID

ORDER BY D.Name;
GO

