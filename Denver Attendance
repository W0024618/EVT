USE [ACVSUJournal_00010021];
GO
SET NOCOUNT ON;

SELECT
  D.ObjectID                AS DoorObjectID,
  D.Name                    AS DoorName,
  D.GUID                    AS DoorGUID,
  D.ControllerID            AS ControllerID,

  clr.ClearanceCount        AS [Clearance Count],
  clr.ClearanceNames        AS [Clearance Details],
  clr.ClearanceDescriptions AS [Clearance Descriptions],
  clr.LatestClearanceTime   AS [Last Modified Time],
  op.Name                   AS [Last Modified By]

FROM ACVSCore.Access.Door D

OUTER APPLY (
    SELECT
      COUNT(1) AS ClearanceCount,

      -- names
      STUFF(
        (
          SELECT ', ' + ISNULL(C2.Name,'')
          FROM ACVSCore.Access.DoorClearancePair DCP
          INNER JOIN ACVSCore.Access.Clearance C2
            ON C2.ObjectID = DCP.ClearanceID
          WHERE DCP.DoorID = D.ObjectID
          FOR XML PATH(''), TYPE
        ).value('.', 'NVARCHAR(MAX)')
      ,1,2,'') AS ClearanceNames,

      -- descriptions
      STUFF(
        (
          SELECT '; ' + ISNULL(C2.Description,'')
          FROM ACVSCore.Access.DoorClearancePair DCP2
          INNER JOIN ACVSCore.Access.Clearance C2
            ON C2.ObjectID = DCP2.ClearanceID
          WHERE DCP2.DoorID = D.ObjectID
          FOR XML PATH(''), TYPE
        ).value('.', 'NVARCHAR(MAX)')
      ,1,2,'') AS ClearanceDescriptions,

      -- most recent LastModifiedTime and its LastModifiedByID
      (SELECT TOP(1) C3.LastModifiedTime
       FROM ACVSCore.Access.DoorClearancePair DCP3
       INNER JOIN ACVSCore.Access.Clearance C3
         ON C3.ObjectID = DCP3.ClearanceID
       WHERE DCP3.DoorID = D.ObjectID
       ORDER BY C3.LastModifiedTime DESC
      ) AS LatestClearanceTime,

      (SELECT TOP(1) C4.LastModifiedByID
       FROM ACVSCore.Access.DoorClearancePair DCP4
       INNER JOIN ACVSCore.Access.Clearance C4
         ON C4.ObjectID = DCP4.ClearanceID
       WHERE DCP4.DoorID = D.ObjectID
       ORDER BY C4.LastModifiedTime DESC
      ) AS LastModifiedByID

) clr

LEFT JOIN ACVSCore.Access.Personnel op
  ON op.ObjectID = clr.LastModifiedByID

ORDER BY D.Name;
GO









USE [ACVSUJournal_00010021];
GO

-- look for candidate association / pair / clearance tables
SELECT TABLE_SCHEMA, TABLE_NAME
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_NAME LIKE '%clear%' OR TABLE_NAME LIKE '%assoc%' OR TABLE_NAME LIKE '%pair%' OR TABLE_NAME LIKE '%door%'
ORDER BY TABLE_NAME;
GO








USE [ACVSUJournal_00010021];
GO
SET NOCOUNT ON;

SELECT
  D.ObjectID                AS DoorObjectID,
  D.Name                    AS DoorName,
  D.GUID                    AS DoorGUID,
  D.ControllerID            AS ControllerID,

  clr.ClearanceCount        AS [Clearance Count],
  clr.ClearanceNames        AS [Clearance Details],
  clr.ClearanceDescriptions AS [Clearance Descriptions],
  clr.LatestClearanceTime   AS [Last Modified Time],
  op.Name                   AS [Last Modified By]

FROM ACVSCore.Access.Door D

OUTER APPLY (
    SELECT
      COUNT(1) AS ClearanceCount,

      -- names
      STUFF(
        (
          SELECT ', ' + ISNULL(C2.Name,'')
          FROM ACVSCore.Access.DoorClearancePair DCP
          INNER JOIN ACVSCore.Access.Clearance C2
            ON C2.ObjectID = DCP.ClearanceID
          WHERE DCP.DoorID = D.ObjectID
          FOR XML PATH(''), TYPE
        ).value('.', 'NVARCHAR(MAX)')
      ,1,2,'') AS ClearanceNames,

      -- descriptions
      STUFF(
        (
          SELECT '; ' + ISNULL(C2.Description,'')
          FROM ACVSCore.Access.DoorClearancePair DCP2
          INNER JOIN ACVSCore.Access.Clearance C2
            ON C2.ObjectID = DCP2.ClearanceID
          WHERE DCP2.DoorID = D.ObjectID
          FOR XML PATH(''), TYPE
        ).value('.', 'NVARCHAR(MAX)')
      ,1,2,'') AS ClearanceDescriptions,

      -- most recent LastModifiedTime and its LastModifiedByID
      (SELECT TOP(1) C3.LastModifiedTime
       FROM ACVSCore.Access.DoorClearancePair DCP3
       INNER JOIN ACVSCore.Access.Clearance C3
         ON C3.ObjectID = DCP3.ClearanceID
       WHERE DCP3.DoorID = D.ObjectID
       ORDER BY C3.LastModifiedTime DESC
      ) AS LatestClearanceTime,

      (SELECT TOP(1) C4.LastModifiedByID
       FROM ACVSCore.Access.DoorClearancePair DCP4
       INNER JOIN ACVSCore.Access.Clearance C4
         ON C4.ObjectID = DCP4.ClearanceID
       WHERE DCP4.DoorID = D.ObjectID
       ORDER BY C4.LastModifiedTime DESC
      ) AS LastModifiedByID

) clr

LEFT JOIN ACVSCore.Access.Personnel op
  ON op.ObjectID = clr.LastModifiedByID

ORDER BY D.Name;
GO










USE [ACVSUJournal_00010021];
GO
SET NOCOUNT ON;

SELECT
  D.ObjectID                AS DoorObjectID,
  D.Name                    AS DoorName,
  D.GUID                    AS DoorGUID,
  D.ControllerID            AS ControllerID,

  clr.ClearanceCount        AS [Clearance Count],
  clr.ClearanceNames        AS [Clearance Details],
  clr.ClearanceDescriptions AS [Clearance Descriptions],
  clr.LatestClearanceTime   AS [Last Modified Time],
  op.Name                   AS [Last Modified By]

FROM ACVSCore.Access.Door D

OUTER APPLY (
    SELECT
      COUNT(1) AS ClearanceCount,

      STUFF((
        SELECT ', ' + ISNULL(C2.Name,'')
        FROM ACVSCore.Access.Association A
        INNER JOIN ACVSCore.Access.Clearance C2
          ON C2.ObjectID = A.ChildObjectID
        WHERE A.ParentObjectID = D.ObjectID
          AND A.ChildObjectType = 'Clearance'  -- remove if column not present
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceNames,

      STUFF((
        SELECT '; ' + ISNULL(C2.Description,'')
        FROM ACVSCore.Access.Association A2
        INNER JOIN ACVSCore.Access.Clearance C2
          ON C2.ObjectID = A2.ChildObjectID
        WHERE A2.ParentObjectID = D.ObjectID
          AND A2.ChildObjectType = 'Clearance'
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceDescriptions,

      (SELECT TOP(1) C3.LastModifiedTime
       FROM ACVSCore.Access.Association A3
       INNER JOIN ACVSCore.Access.Clearance C3 ON C3.ObjectID = A3.ChildObjectID
       WHERE A3.ParentObjectID = D.ObjectID
         AND A3.ChildObjectType = 'Clearance'
       ORDER BY C3.LastModifiedTime DESC
      ) AS LatestClearanceTime,

      (SELECT TOP(1) C4.LastModifiedByID
       FROM ACVSCore.Access.Association A4
       INNER JOIN ACVSCore.Access.Clearance C4 ON C4.ObjectID = A4.ChildObjectID
       WHERE A4.ParentObjectID = D.ObjectID
         AND A4.ChildObjectType = 'Clearance'
       ORDER BY C4.LastModifiedTime DESC
      ) AS LastModifiedByID

) clr

LEFT JOIN ACVSCore.Access.Personnel op
  ON op.ObjectID = clr.LastModifiedByID

ORDER BY D.Name;
GO











SELECT TOP(50) *
FROM ACVSCore.Access.Clearance
WHERE ObjectID IN (
  SELECT ObjectID FROM ACVSCore.Access.Door WHERE Name LIKE '%MainEntrance%'  -- change name
);




SELECT TOP(50 * )
FROM ACVSCore.Access.DoorClearancePair
WHERE DoorID IN (SELECT ObjectID FROM ACVSCore.Access.Door WHERE Name LIKE '%MainEntrance%');






SELECT TOP 50 *
FROM ACVSCore.Access.Association
WHERE ParentObjectID IN (SELECT ObjectID FROM ACVSCore.Access.Door WHERE Name LIKE '%MainEntrance%');














i have run this Query and it Works but we got Wrong data 
like i have review many door have clearance count is more than 2 but here dispplay only 1 count ..
also only few door display clearance details but 90% door display null clerance it is not possible

need t  to fix 

i have upload Schema details and frotend details kindly review each column carefully and fix the issue 


USE [ACVSUJournal_00010021];
GO

SET NOCOUNT ON;

-- Door + Clearance aggregated details
SELECT
  D.ObjectID                 AS DoorObjectID,
  D.Name                     AS DoorName,
  D.GUID                     AS DoorGUID,
  D.ControllerID             AS ControllerID,

  clr.ClearanceCount         AS [Clearance Count],
  clr.ClearanceNames         AS [Clearance Details],       -- concatenated Clearance.Name
  clr.ClearanceDescriptions  AS [Clearance Descriptions],  -- concatenated Clearance.Description
  clr.LatestClearanceTime    AS [Last Modified Time],
  op.Name                    AS [Last Modified By]

FROM ACVSCore.Access.Door D

OUTER APPLY (
    -- Aggregate clearances for this door (assumes Clearance.ObjectID = Door.ObjectID)
    SELECT
      COUNT(1) AS ClearanceCount,

      -- concatenated clearance names (comma separated)
      STUFF((
        SELECT ', ' + ISNULL(C2.Name,'')
        FROM ACVSCore.Access.Clearance C2
        WHERE C2.ObjectID = D.ObjectID
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceNames,

      -- concatenated clearance descriptions (semicolon separated to avoid comma collisions)
      STUFF((
        SELECT '; ' + ISNULL(C2.Description,'')
        FROM ACVSCore.Access.Clearance C2
        WHERE C2.ObjectID = D.ObjectID
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceDescriptions,

      -- latest LastModifiedTime for clearances on this door
      (SELECT TOP(1) C3.LastModifiedTime
       FROM ACVSCore.Access.Clearance C3
       WHERE C3.ObjectID = D.ObjectID
       ORDER BY C3.LastModifiedTime DESC
      ) AS LatestClearanceTime,

      -- LastModifiedByID from the most recent clearance row
      (SELECT TOP(1) C4.LastModifiedByID
       FROM ACVSCore.Access.Clearance C4
       WHERE C4.ObjectID = D.ObjectID
       ORDER BY C4.LastModifiedTime DESC
      ) AS LastModifiedByID
) clr

LEFT JOIN ACVSCore.Access.Personnel op
  ON op.ObjectID = clr.LastModifiedByID

ORDER BY D.Name;
GO

