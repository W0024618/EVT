USE [ACVSUJournal_00010021];
GO
SET NOCOUNT ON;

/*
  Robust Door -> Clearance aggregator.
  - Auto-detects a mapping/pair table that references both Door and Clearance (preferred).
  - If none, tries to detect a generic association table.
  - If none, falls back to Clearance.ObjectID = Door.ObjectID direct mapping.
  - Outputs one row per door with aggregated Clearance info:
     ClearanceCount, ClearanceNames (Name), ClearanceFriendlyNames, ClearanceDescriptions,
     LatestClearanceTime, LastModifiedBy (person name if available).
*/

-- helper: object ids
DECLARE @obj_clearance INT = OBJECT_ID('ACVSCore.Access.Clearance');
DECLARE @obj_door INT      = OBJECT_ID('ACVSCore.Access.Door');

IF @obj_clearance IS NULL
BEGIN
    RAISERROR('Table ACVSCore.Access.Clearance not found. Check schema/name.',16,1);
    RETURN;
END
IF @obj_door IS NULL
BEGIN
    RAISERROR('Table ACVSCore.Access.Door not found. Check schema/name.',16,1);
    RETURN;
END

-- try to find a table that has foreign keys to BOTH Clearance and Door (ideal pair table)
;WITH FKRefs AS (
    SELECT
      fk.object_id AS fk_object_id,           -- foreign key object id
      fkc.parent_object_id AS table_object_id,
      fkc.referenced_object_id
    FROM sys.foreign_keys fk
    JOIN sys.foreign_key_columns fkc ON fkc.constraint_object_id = fk.object_id
)
, TablesReferencingClearance AS (
    SELECT DISTINCT table_object_id
    FROM FKRefs
    WHERE referenced_object_id = @obj_clearance
)
, TablesReferencingDoor AS (
    SELECT DISTINCT table_object_id
    FROM FKRefs
    WHERE referenced_object_id = @obj_door
)
, CandidatePairTables AS (
    SELECT t.table_object_id
    FROM TablesReferencingClearance t
    INNER JOIN TablesReferencingDoor d ON d.table_object_id = t.table_object_id
)
SELECT @obj_clearance AS chk_clear, @obj_door AS chk_door; -- silent check

-- decide which mapping to use
DECLARE @pair_table_object_id INT = NULL;
SELECT TOP(1) @pair_table_object_id = table_object_id FROM CandidatePairTables;

-- If we found a candidate pair table (a table with FKs to both Clearance and Door), use it
IF @pair_table_object_id IS NOT NULL
BEGIN
    DECLARE @schemaName SYSNAME, @tableName SYSNAME;
    SELECT @schemaName = s.name, @tableName = t.name
    FROM sys.tables t
    JOIN sys.schemas s ON t.schema_id = s.schema_id
    WHERE t.object_id = @pair_table_object_id;

    DECLARE @fullPairTable NVARCHAR(200) = QUOTENAME(@schemaName) + '.' + QUOTENAME(@tableName);

    -- find which column(s) in the pair table reference clearance and door (parent columns in the FK)
    DECLARE @doorCol SYSNAME = NULL, @clearanceCol SYSNAME = NULL;

    SELECT TOP(1 @doorCol = pc.name)
    FROM sys.foreign_key_columns fkc
    JOIN sys.columns pc ON pc.object_id = fkc.parent_object_id AND pc.column_id = fkc.parent_column_id
    WHERE fkc.parent_object_id = @pair_table_object_id AND fkc.referenced_object_id = @obj_door;

    SELECT TOP(1 @clearanceCol = pc.name)
    FROM sys.foreign_key_columns fkc
    JOIN sys.columns pc ON pc.object_id = fkc.parent_object_id AND pc.column_id = fkc.parent_column_id
    WHERE fkc.parent_object_id = @pair_table_object_id AND fkc.referenced_object_id = @obj_clearance;

    IF @doorCol IS NULL OR @clearanceCol IS NULL
    BEGIN
        RAISERROR('Found pair table but could not detect DoorID / ClearanceID columns. Aborting.',16,1);
        RETURN;
    END

    -- build and run dynamic SQL using the detected pair table/columns
    DECLARE @sql NVARCHAR(MAX) = N'
    SELECT
      D.ObjectID                AS DoorObjectID,
      D.Name                    AS DoorName,
      D.GUID                    AS DoorGUID,
      D.ControllerID            AS ControllerID,
      ISNULL(T.Cnt,0)           AS [Clearance Count],
      T.ClearanceNames          AS [Clearance Names],         -- Clearance.Name
      T.ClearanceFriendlyNames  AS [Clearance FriendlyNames], -- Clearance.FriendlyName
      T.ClearanceDescriptions   AS [Clearance Descriptions],
      T.LatestClearanceTime     AS [Last Modified Time],
      ISNULL(P.Name, CAST(T.LastModifiedByID AS NVARCHAR(30))) AS [Last Modified By]
    FROM ACVSCore.Access.Door D
    LEFT JOIN (
      SELECT
        P.' + QUOTENAME(@doorCol) + ' AS DoorID,
        COUNT(C.ObjectID) AS Cnt,
        STUFF((
          SELECT '', '' + ISNULL(C2.Name,'''')
          FROM ' + @fullPairTable + ' PP2
          INNER JOIN ACVSCore.Access.Clearance C2 ON C2.ObjectID = PP2.' + QUOTENAME(@clearanceCol) + '
          WHERE PP2.' + QUOTENAME(@doorCol) + ' = P.' + QUOTENAME(@doorCol) + '
          FOR XML PATH(''''), TYPE
        ).value(''.'', ''NVARCHAR(MAX)''),1,2,'''') AS ClearanceNames,
        STUFF((
          SELECT ''; '' + ISNULL(C2.FriendlyName,'''')
          FROM ' + @fullPairTable + ' PP3
          INNER JOIN ACVSCore.Access.Clearance C2 ON C2.ObjectID = PP3.' + QUOTENAME(@clearanceCol) + '
          WHERE PP3.' + QUOTENAME(@doorCol) + ' = P.' + QUOTENAME(@doorCol) + '
          FOR XML PATH(''''), TYPE
        ).value(''.'', ''NVARCHAR(MAX)''),1,2,'''') AS ClearanceFriendlyNames,
        STUFF((
          SELECT ''; '' + ISNULL(C2.Description,'''')
          FROM ' + @fullPairTable + ' PP4
          INNER JOIN ACVSCore.Access.Clearance C2 ON C2.ObjectID = PP4.' + QUOTENAME(@clearanceCol) + '
          WHERE PP4.' + QUOTENAME(@doorCol) + ' = P.' + QUOTENAME(@doorCol) + '
          FOR XML PATH(''''), TYPE
        ).value(''.'', ''NVARCHAR(MAX)''),1,2,'''') AS ClearanceDescriptions,
        (SELECT TOP(1) C3.LastModifiedTime
         FROM ' + @fullPairTable + ' PP5
         INNER JOIN ACVSCore.Access.Clearance C3 ON C3.ObjectID = PP5.' + QUOTENAME(@clearanceCol) + '
         WHERE PP5.' + QUOTENAME(@doorCol) + ' = P.' + QUOTENAME(@doorCol) + '
         ORDER BY C3.LastModifiedTime DESC
        ) AS LatestClearanceTime,
        (SELECT TOP(1) C4.LastModifiedByID
         FROM ' + @fullPairTable + ' PP6
         INNER JOIN ACVSCore.Access.Clearance C4 ON C4.ObjectID = PP6.' + QUOTENAME(@clearanceCol) + '
         WHERE PP6.' + QUOTENAME(@doorCol) + ' = P.' + QUOTENAME(@doorCol) + '
         ORDER BY C4.LastModifiedTime DESC
        ) AS LastModifiedByID
      FROM ' + @fullPairTable + ' P
      LEFT JOIN ACVSCore.Access.Clearance C ON C.ObjectID = P.' + QUOTENAME(@clearanceCol) + '
      GROUP BY P.' + QUOTENAME(@doorCol) + '
    ) T ON T.DoorID = D.ObjectID
    LEFT JOIN ACVSCore.Access.Personnel P ON P.ObjectID = T.LastModifiedByID
    ORDER BY D.Name;';

    EXEC sp_executesql @sql;
    RETURN;
END

-- If pair table not found, attempt to find an association-style table that references Door and Clearance
DECLARE @assoc_table_object_id INT = NULL;

;WITH AllTablesWithClearanceFK AS (
    SELECT DISTINCT fkc.parent_object_id AS table_object_id
    FROM sys.foreign_key_columns fkc
    WHERE fkc.referenced_object_id = @obj_clearance
),
AllTablesWithDoorFK AS (
    SELECT DISTINCT fkc.parent_object_id AS table_object_id
    FROM sys.foreign_key_columns fkc
    WHERE fkc.referenced_object_id = @obj_door
)
SELECT TOP(1) @assoc_table_object_id = t.table_object_id
FROM AllTablesWithClearanceFK t
WHERE t.table_object_id IN (SELECT table_object_id FROM AllTablesWithDoorFK);

IF @assoc_table_object_id IS NOT NULL
BEGIN
    DECLARE @assoc_schema SYSNAME, @assoc_table SYSNAME;
    SELECT @assoc_schema = s.name, @assoc_table = t.name
    FROM sys.tables t
    JOIN sys.schemas s ON t.schema_id = s.schema_id
    WHERE t.object_id = @assoc_table_object_id;

    DECLARE @fullAssocTable NVARCHAR(200) = QUOTENAME(@assoc_schema) + '.' + QUOTENAME(@assoc_table);

    -- detect columns that reference door and clearance
    DECLARE @assocDoorCol SYSNAME = NULL, @assocClearCol SYSNAME = NULL;
    SELECT TOP(1 @assocDoorCol = pc.name)
    FROM sys.foreign_key_columns fkc
    JOIN sys.columns pc ON pc.object_id = fkc.parent_object_id AND pc.column_id = fkc.parent_column_id
    WHERE fkc.parent_object_id = @assoc_table_object_id AND fkc.referenced_object_id = @obj_door;

    SELECT TOP(1 @assocClearCol = pc.name)
    FROM sys.foreign_key_columns fkc
    JOIN sys.columns pc ON pc.object_id = fkc.parent_object_id AND pc.column_id = fkc.parent_column_id
    WHERE fkc.parent_object_id = @assoc_table_object_id AND fkc.referenced_object_id = @obj_clearance;

    IF @assocDoorCol IS NULL OR @assocClearCol IS NULL
    BEGIN
        RAISERROR('Found association table but could not resolve referencing columns. Aborting.',16,1);
        RETURN;
    END

    DECLARE @sql2 NVARCHAR(MAX) = N'
    SELECT
      D.ObjectID                AS DoorObjectID,
      D.Name                    AS DoorName,
      D.GUID                    AS DoorGUID,
      D.ControllerID            AS ControllerID,
      ISNULL(T.Cnt,0)           AS [Clearance Count],
      T.ClearanceNames          AS [Clearance Names],
      T.ClearanceFriendlyNames  AS [Clearance FriendlyNames],
      T.ClearanceDescriptions   AS [Clearance Descriptions],
      T.LatestClearanceTime     AS [Last Modified Time],
      ISNULL(P.NAME, CAST(T.LastModifiedByID AS NVARCHAR(30))) AS [Last Modified By]
    FROM ACVSCore.Access.Door D
    LEFT JOIN (
      SELECT
        A.' + QUOTENAME(@assocDoorCol) + ' AS DoorID,
        COUNT(C.ObjectID) AS Cnt,
        STUFF((
          SELECT '', '' + ISNULL(C2.Name,'''')
          FROM ' + @fullAssocTable + ' A2
          INNER JOIN ACVSCore.Access.Clearance C2 ON C2.ObjectID = A2.' + QUOTENAME(@assocClearCol) + '
          WHERE A2.' + QUOTENAME(@assocDoorCol) + ' = A.' + QUOTENAME(@assocDoorCol) + '
          FOR XML PATH(''''), TYPE
        ).value(''.'', ''NVARCHAR(MAX)''),1,2,'''') AS ClearanceNames,
        STUFF((
          SELECT ''; '' + ISNULL(C2.FriendlyName,'''')
          FROM ' + @fullAssocTable + ' A3
          INNER JOIN ACVSCore.Access.Clearance C2 ON C2.ObjectID = A3.' + QUOTENAME(@assocClearCol) + '
          WHERE A3.' + QUOTENAME(@assocDoorCol) + ' = A.' + QUOTENAME(@assocDoorCol) + '
          FOR XML PATH(''''), TYPE
        ).value(''.'', ''NVARCHAR(MAX)''),1,2,'''') AS ClearanceFriendlyNames,
        STUFF((
          SELECT ''; '' + ISNULL(C2.Description,'''')
          FROM ' + @fullAssocTable + ' A4
          INNER JOIN ACVSCore.Access.Clearance C2 ON C2.ObjectID = A4.' + QUOTENAME(@assocClearCol) + '
          WHERE A4.' + QUOTENAME(@assocDoorCol) + ' = A.' + QUOTENAME(@assocDoorCol) + '
          FOR XML PATH(''''), TYPE
        ).value(''.'', ''NVARCHAR(MAX)''),1,2,'''') AS ClearanceDescriptions,
        (SELECT TOP(1) C3.LastModifiedTime
         FROM ' + @fullAssocTable + ' A5
         INNER JOIN ACVSCore.Access.Clearance C3 ON C3.ObjectID = A5.' + QUOTENAME(@assocClearCol) + '
         WHERE A5.' + QUOTENAME(@assocDoorCol) + ' = A.' + QUOTENAME(@assocDoorCol) + '
         ORDER BY C3.LastModifiedTime DESC) AS LatestClearanceTime,
        (SELECT TOP(1) C4.LastModifiedByID
         FROM ' + @fullAssocTable + ' A6
         INNER JOIN ACVSCore.Access.Clearance C4 ON C4.ObjectID = A6.' + QUOTENAME(@assocClearCol) + '
         WHERE A6.' + QUOTENAME(@assocDoorCol) + ' = A.' + QUOTENAME(@assocDoorCol) + '
         ORDER BY C4.LastModifiedTime DESC) AS LastModifiedByID
      FROM ' + @fullAssocTable + ' A
      LEFT JOIN ACVSCore.Access.Clearance C ON C.ObjectID = A.' + QUOTENAME(@assocClearCol) + '
      GROUP BY A.' + QUOTENAME(@assocDoorCol) + '
    ) T ON T.DoorID = D.ObjectID
    LEFT JOIN ACVSCore.Access.Personnel P ON P.ObjectID = T.LastModifiedByID
    ORDER BY D.Name;
    ';

    EXEC sp_executesql @sql2;
    RETURN;
END

-- Fallback: direct mapping Clearance.ObjectID = Door.ObjectID (some installations use this)
-- Note: you told earlier this returns values for many clearances; still include FriendlyName and Name.
SELECT
  D.ObjectID                AS DoorObjectID,
  D.Name                    AS DoorName,
  D.GUID                    AS DoorGUID,
  D.ControllerID            AS ControllerID,
  ISNULL(T.Cnt,0)           AS [Clearance Count],
  T.ClearanceNames          AS [Clearance Names],         -- C.Name
  T.ClearanceFriendlyNames  AS [Clearance FriendlyNames], -- C.FriendlyName
  T.ClearanceDescriptions   AS [Clearance Descriptions],
  T.LatestClearanceTime     AS [Last Modified Time],
  ISNULL(P.Name, CAST(T.LastModifiedByID AS NVARCHAR(30))) AS [Last Modified By]
FROM ACVSCore.Access.Door D
LEFT JOIN (
  SELECT
    C.ObjectID AS DoorID,
    COUNT(*) AS Cnt,
    STUFF((SELECT ', ' + ISNULL(C2.Name,'')   FROM ACVSCore.Access.Clearance C2 WHERE C2.ObjectID = C.ObjectID FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'),1,2,'') AS ClearanceNames,
    STUFF((SELECT '; ' + ISNULL(C2.FriendlyName,'') FROM ACVSCore.Access.Clearance C2 WHERE C2.ObjectID = C.ObjectID FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'),1,2,'') AS ClearanceFriendlyNames,
    STUFF((SELECT '; ' + ISNULL(C2.Description,'') FROM ACVSCore.Access.Clearance C2 WHERE C2.ObjectID = C.ObjectID FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'),1,2,'') AS ClearanceDescriptions,
    (SELECT TOP(1) C3.LastModifiedTime FROM ACVSCore.Access.Clearance C3 WHERE C3.ObjectID = C.ObjectID ORDER BY C3.LastModifiedTime DESC) AS LatestClearanceTime,
    (SELECT TOP(1) C4.LastModifiedByID FROM ACVSCore.Access.Clearance C4 WHERE C4.ObjectID = C.ObjectID ORDER BY C4.LastModifiedTime DESC) AS LastModifiedByID
  FROM ACVSCore.Access.Clearance C
  GROUP BY C.ObjectID
) T ON T.DoorID = D.ObjectID
LEFT JOIN ACVSCore.Access.Personnel P ON P.ObjectID = T.LastModifiedByID
ORDER BY D.Name;
GO


















i have review issue in Query need to fix

When i run this Query 
select * from ACVSCore.Access.Clearance
We got all door details 

we got Column like 

ObjectID	Name	Description	GUID	ClassType	Protected	PartitionID	LastModifiedTime	LastModifiedByID	ActivationDate	ExpirationDate	Custom	Template	UseActivationDate	UseExpirationDate	PersonnelID	FriendlyName

use  (Name)  Column for clerance details 
Name Column porvide rewsult like ..APAC IN Pune TEC Tower B Gym Restricted Access
Description -- this Column display -L1 Approver - Rohit Singla - 326430   L2 Approver - Sameer Kanade - 311084
LastModifiedTime--- use this column 
FriendlyName--- this Column name is imprtant .this column gave data like APAC IN Pune TEC Tower B Gym Restricted Access
Update below Query as per above and fix the issue carefully ...


																
USE [ACVSUJournal_00010021];
GO
SET NOCOUNT ON;

-- Temp table to accumulate results from multiple possible mapping patterns
IF OBJECT_ID('tempdb..#DoorClearances') IS NOT NULL DROP TABLE #DoorClearances;

CREATE TABLE #DoorClearances (
    DoorObjectID BIGINT,
    ClearanceCount INT,
    ClearanceNames NVARCHAR(MAX),
    ClearanceDescriptions NVARCHAR(MAX),
    LatestClearanceTime DATETIME2,
    LastModifiedByID BIGINT
);

---------------------------------------------------------------------
-- 1) Direct mapping: Clearance.ObjectID = Door.ObjectID
--    (safe to run because Clearance and Door exist in your DB)
---------------------------------------------------------------------
IF OBJECT_ID('ACVSCore.Access.Clearance','U') IS NOT NULL
AND OBJECT_ID('ACVSCore.Access.Door','U') IS NOT NULL
BEGIN
    INSERT INTO #DoorClearances (DoorObjectID, ClearanceCount, ClearanceNames, ClearanceDescriptions, LatestClearanceTime, LastModifiedByID)
    SELECT
      D.ObjectID AS DoorObjectID,
      COUNT(C.ObjectID) AS ClearanceCount,
      STUFF((
        SELECT ', ' + ISNULL(C2.Name,'')
        FROM ACVSCore.Access.Clearance C2
        WHERE C2.ObjectID = D.ObjectID
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceNames,
      STUFF((
        SELECT '; ' + ISNULL(C2.Description,'')
        FROM ACVSCore.Access.Clearance C2
        WHERE C2.ObjectID = D.ObjectID
        FOR XML PATH(''), TYPE
      ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceDescriptions,
      (SELECT TOP(1) C3.LastModifiedTime
       FROM ACVSCore.Access.Clearance C3
       WHERE C3.ObjectID = D.ObjectID
       ORDER BY C3.LastModifiedTime DESC) AS LatestClearanceTime,
      (SELECT TOP(1) C4.LastModifiedByID
       FROM ACVSCore.Access.Clearance C4
       WHERE C4.ObjectID = D.ObjectID
       ORDER BY C4.LastModifiedTime DESC) AS LastModifiedByID
    FROM ACVSCore.Access.Door D
    LEFT JOIN ACVSCore.Access.Clearance C
      ON C.ObjectID = D.ObjectID
    GROUP BY D.ObjectID;
END

---------------------------------------------------------------------
-- 2) Pair table pattern: ACVSCore.Access.<Something> with columns DoorID and ClearanceID
--    (e.g. DoorClearancePair or similarly named table)
--    We check for a table that has both columns and then use it.
---------------------------------------------------------------------
DECLARE @pairTableName SYSNAME = NULL;

SELECT TOP(1) @pairTableName = QUOTENAME(s.name) + '.' + QUOTENAME(t.name)
FROM sys.schemas s
JOIN sys.tables t ON t.schema_id = s.schema_id
JOIN sys.columns c1 ON c1.object_id = t.object_id AND LOWER(c1.name) IN ('doorid','door_id')
JOIN sys.columns c2 ON c2.object_id = t.object_id AND LOWER(c2.name) IN ('clearanceid','clearance_id')
WHERE LOWER(s.name) = 'access' AND LOWER(s.name) IS NOT NULL
  AND (t.name LIKE '%door%clear%' OR t.name LIKE '%clear%pair%' OR t.name LIKE '%clear%door%' OR t.name LIKE '%clearance%pair%');

-- If not found in Access schema, search all schemas
IF @pairTableName IS NULL
BEGIN
    SELECT TOP(1) @pairTableName = QUOTENAME(s.name) + '.' + QUOTENAME(t.name)
    FROM sys.schemas s
    JOIN sys.tables t ON t.schema_id = s.schema_id
    JOIN sys.columns c1 ON c1.object_id = t.object_id AND LOWER(c1.name) IN ('doorid','door_id')
    JOIN sys.columns c2 ON c2.object_id = t.object_id AND LOWER(c2.name) IN ('clearanceid','clearance_id')
    WHERE t.name LIKE '%door%clear%' OR t.name LIKE '%clear%pair%' OR t.name LIKE '%clear%door%' OR t.name LIKE '%clearance%pair%';
END

IF @pairTableName IS NOT NULL
BEGIN
    DECLARE @sql NVARCHAR(MAX) = N'
    INSERT INTO #DoorClearances (DoorObjectID, ClearanceCount, ClearanceNames, ClearanceDescriptions, LatestClearanceTime, LastModifiedByID)
    SELECT
      D.ObjectID AS DoorObjectID,
      COUNT(C2.ObjectID) AS ClearanceCount,
      STUFF((
        SELECT '', '' + ISNULL(C3.Name,'''')
        FROM ' + @pairTableName + ' P
        INNER JOIN ACVSCore.Access.Clearance C3 ON C3.ObjectID = P.ClearanceID
        WHERE P.DoorID = D.ObjectID
        FOR XML PATH(''''), TYPE
      ).value(''.'', ''NVARCHAR(MAX)''), 1, 2, '''') AS ClearanceNames,
      STUFF((
        SELECT ''; '' + ISNULL(C3.Description,'''')
        FROM ' + @pairTableName + ' P2
        INNER JOIN ACVSCore.Access.Clearance C3 ON C3.ObjectID = P2.ClearanceID
        WHERE P2.DoorID = D.ObjectID
        FOR XML PATH(''''), TYPE
      ).value(''.'', ''NVARCHAR(MAX)''), 1, 2, '''') AS ClearanceDescriptions,
      (SELECT TOP(1) C4.LastModifiedTime
       FROM ' + @pairTableName + ' P3
       INNER JOIN ACVSCore.Access.Clearance C4 ON C4.ObjectID = P3.ClearanceID
       WHERE P3.DoorID = D.ObjectID
       ORDER BY C4.LastModifiedTime DESC) AS LatestClearanceTime,
      (SELECT TOP(1) C5.LastModifiedByID
       FROM ' + @pairTableName + ' P4
       INNER JOIN ACVSCore.Access.Clearance C5 ON C5.ObjectID = P4.ClearanceID
       WHERE P4.DoorID = D.ObjectID
       ORDER BY C5.LastModifiedTime DESC) AS LastModifiedByID
    FROM ACVSCore.Access.Door D
    LEFT JOIN ' + @pairTableName + ' P_all ON P_all.DoorID = D.ObjectID
    LEFT JOIN ACVSCore.Access.Clearance C ON C.ObjectID = P_all.ClearanceID
    GROUP BY D.ObjectID;
    ';

    EXEC sp_executesql @sql;
END

---------------------------------------------------------------------
-- 3) Generic association table pattern (common names: Association, Associations, ObjectAssociation)
--    We look for a table that has columns like ParentObjectID/ChildObjectID (or parent_id/child_id)
---------------------------------------------------------------------
DECLARE @assocTableName SYSNAME = NULL;

SELECT TOP(1) @assocTableName = QUOTENAME(s.name) + '.' + QUOTENAME(t.name)
FROM sys.schemas s
JOIN sys.tables t ON t.schema_id = s.schema_id
JOIN sys.columns pc ON pc.object_id = t.object_id AND LOWER(pc.name) IN ('parentobjectid','parentid','parent_object_id')
JOIN sys.columns cc ON cc.object_id = t.object_id AND LOWER(cc.name) IN ('childobjectid','childid','child_object_id')
WHERE t.name LIKE '%assoc%' OR t.name LIKE '%association%' OR t.name LIKE '%link%';

IF @assocTableName IS NOT NULL
BEGIN
    DECLARE @sql2 NVARCHAR(MAX) = N'
    INSERT INTO #DoorClearances (DoorObjectID, ClearanceCount, ClearanceNames, ClearanceDescriptions, LatestClearanceTime, LastModifiedByID)
    SELECT
      D.ObjectID AS DoorObjectID,
      COUNT(C2.ObjectID) AS ClearanceCount,
      STUFF((
        SELECT '', '' + ISNULL(C3.Name,'''')
        FROM ' + @assocTableName + ' A
        INNER JOIN ACVSCore.Access.Clearance C3 ON C3.ObjectID = A.ChildObjectID
        WHERE A.ParentObjectID = D.ObjectID
          AND (A.ChildObjectType IS NULL OR A.ChildObjectType = ''Clearance'')
        FOR XML PATH(''''), TYPE
      ).value(''.'', ''NVARCHAR(MAX)''), 1, 2, '''') AS ClearanceNames,
      STUFF((
        SELECT ''; '' + ISNULL(C3.Description,'''')
        FROM ' + @assocTableName + ' A2
        INNER JOIN ACVSCore.Access.Clearance C3 ON C3.ObjectID = A2.ChildObjectID
        WHERE A2.ParentObjectID = D.ObjectID
          AND (A2.ChildObjectType IS NULL OR A2.ChildObjectType = ''Clearance'')
        FOR XML PATH(''''), TYPE
      ).value(''.'', ''NVARCHAR(MAX)''), 1, 2, '''') AS ClearanceDescriptions,
      (SELECT TOP(1) C4.LastModifiedTime
       FROM ' + @assocTableName + ' A3
       INNER JOIN ACVSCore.Access.Clearance C4 ON C4.ObjectID = A3.ChildObjectID
       WHERE A3.ParentObjectID = D.ObjectID
         AND (A3.ChildObjectType IS NULL OR A3.ChildObjectType = ''Clearance'')
       ORDER BY C4.LastModifiedTime DESC) AS LatestClearanceTime,
      (SELECT TOP(1) C5.LastModifiedByID
       FROM ' + @assocTableName + ' A4
       INNER JOIN ACVSCore.Access.Clearance C5 ON C5.ObjectID = A4.ChildObjectID
       WHERE A4.ParentObjectID = D.ObjectID
         AND (A4.ChildObjectType IS NULL OR A4.ChildObjectType = ''Clearance'')
       ORDER BY C5.LastModifiedTime DESC) AS LastModifiedByID
    FROM ACVSCore.Access.Door D
    LEFT JOIN ' + @assocTableName + ' A_all ON A_all.ParentObjectID = D.ObjectID
    LEFT JOIN ACVSCore.Access.Clearance C_all ON C_all.ObjectID = A_all.ChildObjectID
    GROUP BY D.ObjectID;
    ';

    EXEC sp_executesql @sql2;
END

---------------------------------------------------------------------
-- Final result: list all doors and show aggregated clearance info (one row per door)
---------------------------------------------------------------------
SELECT
  D.ObjectID                AS DoorObjectID,
  D.Name                    AS DoorName,
  D.GUID                    AS DoorGUID,
  D.ControllerID            AS ControllerID,
  DC.ClearanceCount         AS [Clearance Count],
  DC.ClearanceNames         AS [Clearance Details],
  DC.ClearanceDescriptions  AS [Clearance Descriptions],
  DC.LatestClearanceTime    AS [Last Modified Time],
  COALESCE(P.Name, CAST(DC.LastModifiedByID AS NVARCHAR(30))) AS [Last Modified By]
FROM ACVSCore.Access.Door D
LEFT JOIN (
    -- collapse duplicates if multiple methods found the same DoorObjectID
    SELECT DoorObjectID,
           MAX(ClearanceCount) AS ClearanceCount,
           STUFF((
             SELECT '; ' + ISNULL(t2.ClearanceNames,'')
             FROM #DoorClearances t2
             WHERE t2.DoorObjectID = t.DoorObjectID
             FOR XML PATH(''), TYPE
           ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceNames,
           STUFF((
             SELECT '||' + ISNULL(t2.ClearanceDescriptions,'')
             FROM #DoorClearances t2
             WHERE t2.DoorObjectID = t.DoorObjectID
             FOR XML PATH(''), TYPE
           ).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ClearanceDescriptions,
           MAX(LatestClearanceTime) AS LatestClearanceTime,
           MAX(LastModifiedByID) AS LastModifiedByID
    FROM #DoorClearances t
    GROUP BY DoorObjectID
) DC ON DC.DoorObjectID = D.ObjectID
LEFT JOIN ACVSCore.Access.Personnel P
  ON P.ObjectID = DC.LastModifiedByID
ORDER BY D.Name;

-- cleanup
DROP TABLE #DoorClearances;
GO


